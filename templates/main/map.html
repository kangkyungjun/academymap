
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학원 지도</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c9bd03a648dc9479e4ea809402b541f1&libraries=clusterer"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,200,0,0&icon_names=my_location" />
    <style>
.material-symbols-outlined {
  font-variation-settings:
  'FILL' 0,
  'wght' 200,
  'GRAD' 0,
  'opsz' 24
}

</style>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #f0f8f8;
        }

        #map {
            width: 100%;
            height: 90%;
        }

        #controls {
            position: fixed;
            top: 5rem;
            right: 1rem;
            z-index: 1000;
        }
        ::-webkit-scrollbar {
          display: none;
        }
        #controls::-webkit-scrollbar{
              display:none;
        }


        #controls button {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            border: none;
            border-radius: 0.5rem;
            background-color: #008B8B;
            color: #fff;
            cursor: pointer;
        }


        #controls button:hover {
            background-color: #006767;
        }

        #category-container {
            position: absolute;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            overflow-x: auto;
            white-space: nowrap;
            z-index: 100;
            padding: 0.5rem 0;
            background-color: rgba(0, 139, 139, 0.1);
            border-radius: 0.5rem;
        }

        #category button {
            flex: 0 0 auto;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid #008B8B;
            border-radius: 0.3rem;
            background-color: #fff;
            color: #008B8B;
        }

        #category button:hover, #category button.active {
            background-color: #008B8B;
            color: #fff;
        }

        #info {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background-color: #fff;
            padding: 1rem;
            transition: bottom 0.4s ease-in-out;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            z-index: 10;
        }

        #info.active {
            bottom: 0;
        }

        #info ul {
            list-style: none;
            padding: 0;
        }

        #info li {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        #info .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #008B8B;
        }
    </style>
</head>

<body>

    <a class="searched-list" href="{% url 'academy_list' %}">
        ←검색
    </a>

    <div id="controls">
        <button onclick="moveToCurrentLocation()"><span class="material-symbols-outlined">my_location</span></button>
    </div>

<!-- 카테고리 버튼 (지도 상단 고정 & 가로 스크롤) -->
<div id="category-container">
    <div id="category">
        <button onclick="filterMarkers('전체')">전체</button>
        <button onclick="filterMarkers('수학')">수학</button>
        <button onclick="filterMarkers('영어')">영어</button>
        <button onclick="filterMarkers('과학')">과학</button>
        <button onclick="filterMarkers('외국어')">외국어</button>
        <button onclick="filterMarkers('예체능')">예체능</button>
        <button onclick="filterMarkers('컴퓨터')">컴퓨터</button>
        <button onclick="filterMarkers('논술')">논술</button>
        <button onclick="filterMarkers('기타')">기타</button>
        <button onclick="filterMarkers('독서실/스터디카페')">독서실/스터디카페</button>
    </div>
</div>

    <div id="map"></div>



    <div id="info">
        <button class="close-btn" onclick="closeInfo()">×</button>
        <ul id="academyInfo"></ul>
    </div>

<script>
    function moveToCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var locPosition = new kakao.maps.LatLng(lat, lng);

            map.setCenter(locPosition);  // 지도 중심 이동
            map.setLevel(2);             // 확대 레벨 조정

            // 현재 위치 마커 표시
            if (!currentPositionOverlay) {
                currentPositionOverlay = new kakao.maps.Marker({
                    map: map,
                    position: locPosition,
                    title: "현재 위치",
                    image: new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png',
                        new kakao.maps.Size(24, 35)
                    )
                });
            } else {
                currentPositionOverlay.setPosition(locPosition);
            }

        }, function(error) {
            alert('위치 정보를 가져올 수 없습니다.');
            console.error("Geolocation Error:", error);
        });
    } else {
        alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
    }
}

    var map, clusterer, selectedCategory = '전체', currentPositionOverlay, currentLocation;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            currentLocation = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
            initializeMap(currentLocation);
            showCurrentLocation(currentLocation);
        });
    } else {
        var defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
        initializeMap(defaultPosition);
    }

    function initializeMap(center) {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: center,
            level: 3
        });

        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 4,
            disableClickZoom: false
        });

        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            map.setLevel(map.getLevel() - 1, { anchor: cluster.getCenter() });
        });

        kakao.maps.event.addListener(map, 'bounds_changed', fetchAcademies);

        fetchAcademies();
    }

    function showCurrentLocation(locPosition) {
        if (!currentPositionOverlay) {
            currentPositionOverlay = new kakao.maps.CustomOverlay({
                position: locPosition,
                content: `<div style="width:0.625rem; height:0.625rem; background-color:red; border-radius:50%;"></div>`,
                zIndex: 1
            });
            currentPositionOverlay.setMap(map);
        } else {
            currentPositionOverlay.setPosition(locPosition);
        }
    }

    function fetchAcademies() {
        var bounds = map.getBounds();
        var swLatLng = bounds.getSouthWest();
        var neLatLng = bounds.getNorthEast();

        fetch('/api/filtered_academies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                swLat: swLatLng.getLat(),
                swLng: swLatLng.getLng(),
                neLat: neLatLng.getLat(),
                neLng: neLatLng.getLng(),
                category: selectedCategory
            })
        })
        .then(response => response.json())
        .then(data => {
            clusterer.clear();
            var markers = data.map(function(item) {
                var marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(item.위도, item.경도),
                    title: item.상호명
                });

                kakao.maps.event.addListener(marker, 'click', function() {
                    console.log("마커 클릭: ", item);
                    showAcademyInfo(item);
                });

                return marker;
            });

            clusterer.addMarkers(markers);
        })
        .catch(error => console.error('Error fetching academies:', error));  // 오류 수정
    }

    function filterMarkers(category) {
        selectedCategory = category;
        fetchAcademies();
    }

    function showAcademyInfo(data) {
        var infoList = document.getElementById('academyInfo');
        document.getElementById('info').classList.add('active');
        infoList.innerHTML = `
            <li><strong><a href="/academy/${data.id}">${data.상호명}</a></strong></li>
            <li><strong>도로명주소:</strong> ${data.도로명주소}</li>
            <li><strong>전화번호:</strong> ${data.전화번호}</li>
        `;
    }

    function closeInfo() {
        document.getElementById('info').classList.remove('active');
    }

    function getCSRFToken() {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length);
            }
        }
        return '';
    }

    // 드래그 스크롤 기능 추가
const categoryContainer = document.getElementById('category-container');
let isDown = false;
let startX, scrollLeft;

categoryContainer.addEventListener('mousedown', (e) => {
    isDown = true;
    categoryContainer.classList.add('active');
    startX = e.pageX - categoryContainer.offsetLeft;
    scrollLeft = categoryContainer.scrollLeft;
});

categoryContainer.addEventListener('mouseleave', () => {
    isDown = false;
    categoryContainer.classList.remove('active');
});

categoryContainer.addEventListener('mouseup', () => {
    isDown = false;
    categoryContainer.classList.remove('active');
});

categoryContainer.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - categoryContainer.offsetLeft;
    const walk = (x - startX) * 1.5;  // 드래그 감도 조절
    categoryContainer.scrollLeft = scrollLeft - walk;
});

// 터치 이벤트 (모바일 지원)
categoryContainer.addEventListener('touchstart', (e) => {
    isDown = true;
    startX = e.touches[0].pageX - categoryContainer.offsetLeft;
    scrollLeft = categoryContainer.scrollLeft;
});

categoryContainer.addEventListener('touchend', () => {
    isDown = false;
});

categoryContainer.addEventListener('touchmove', (e) => {
    if (!isDown) return;
    const x = e.touches[0].pageX - categoryContainer.offsetLeft;
    const walk = (x - startX) * 1.5;  // 드래그 감도 조절
    categoryContainer.scrollLeft = scrollLeft - walk;
});



</script>
    <script>
    kakao.maps.event.addListener(map, 'dragstart', function() {
      map.setDraggable(false);
    });

    kakao.maps.event.addListener(map, 'dragend', function() {
      map.setDraggable(true);
    });

    let isPinching = false;
    let lastDistance;

    map.container.addEventListener('touchstart', function(e) {
      if (e.touches.length === 2) {
        isPinching = true;
        lastDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      }
    });

    map.container.addEventListener('touchmove', function(e) {
      if (isPinching && e.touches.length === 2) {
        const currentDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        const zoomDelta = (currentDistance - lastDistance) * 0.01;
        map.setLevel(map.getLevel() + zoomDelta);
        lastDistance = currentDistance;
      }
    });

    map.container.addEventListener('touchend', function() {
      isPinching = false;
    });

    </script>
</body>
</html>
