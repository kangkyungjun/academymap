<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>학원 지도</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c9bd03a648dc9479e4ea809402b541f1&libraries=clusterer"></script>
<style>
    #map { width: 100%; height: 400px; }
    #category { margin: 10px 0; }
    #category button { margin-right: 5px; padding: 5px 10px; cursor: pointer; }
    #controls { margin: 10px 0; }
    #controls button { padding: 5px 10px; cursor: pointer; }
    #info { margin-top: 10px; }
    #info ul { list-style: none; padding: 0; }
    #info li { margin-bottom: 5px; }
</style>
</head>
<body>
    <h1>학원 지도</h1>
    <div id="category">
        <button onclick="filterMarkers('전체')">전체</button>
        <button onclick="filterMarkers('수학')">수학</button>
        <button onclick="filterMarkers('영어')">영어</button>
        <button onclick="filterMarkers('과학')">과학</button>
        <button onclick="filterMarkers('외국어')">외국어</button>
        <button onclick="filterMarkers('컴퓨터')">컴퓨터</button>
        <button onclick="filterMarkers('예체능')">예체능</button>
        <button onclick="filterMarkers('기타')">기타</button>
        <button onclick="filterMarkers('독서실 / 스터디카페')">독서실 / 스터디카페</button>
    </div>
    <div id="map"></div>
    <div id="controls">
    <button onclick="moveToCurrentLocation()">현 위치로 이동</button>
</div>
    <div id="info">
        <ul id="academyInfo"></ul>
    </div>

<script>
    var map, clusterer, selectedCategory = '전체', currentPositionOverlay, currentLocation;

    // 지도 초기화
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            currentLocation = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
            initializeMap(currentLocation);
            showCurrentLocation(currentLocation); // 현재 위치를 빨간 점으로 표시
        });
    } else {
        var defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567); // 서울 기본 위치
        initializeMap(defaultPosition);
    }

    function initializeMap(center) {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: center,
            level: 4
        });

        // 마커 클러스터러 생성
        clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 4,
            disableClickZoom: false // 클릭 시 줌 활성화
        });

        // 클러스터 클릭 시 배율 확대
        kakao.maps.event.addListener(clusterer, 'clusterclick', function(cluster) {
            map.setLevel(map.getLevel() - 1, { anchor: cluster.getCenter() });
        });

        // 지도 영역 변경 시 학원 데이터 가져오기
        kakao.maps.event.addListener(map, 'bounds_changed', fetchAcademies);

        // 초기 데이터 로드
        fetchAcademies();
    }

    function showCurrentLocation(locPosition) {
        // 현재 위치를 빨간 점(커스텀 오버레이)으로 표시
        if (!currentPositionOverlay) {
            currentPositionOverlay = new kakao.maps.CustomOverlay({
                position: locPosition,
                content: `<div style="width:10px; height:10px; background-color:red; border-radius:50%;"></div>`,
                zIndex: 1
            });
            currentPositionOverlay.setMap(map);
        } else {
            currentPositionOverlay.setPosition(locPosition); // 위치 갱신
        }
    }

    function fetchAcademies() {
        // 현재 지도 영역의 좌표 가져오기
        var bounds = map.getBounds();
        var swLatLng = bounds.getSouthWest();
        var neLatLng = bounds.getNorthEast();

        // 서버에 데이터 요청
        fetch('/api/filtered_academies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() // CSRF 토큰 추가
            },
            body: JSON.stringify({
                swLat: swLatLng.getLat(),
                swLng: swLatLng.getLng(),
                neLat: neLatLng.getLat(),
                neLng: neLatLng.getLng(),
                category: selectedCategory
            })
        })
        .then(response => response.json())
        .then(data => {
            clusterer.clear(); // 기존 마커 제거

            // 새 마커 추가
            var markers = data.map(function(item) {
                var marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(item.위도, item.경도),
                    title: item.상호명
                });

                kakao.maps.event.addListener(marker, 'click', function() {
                    showAcademyInfo(item);
                });

                return marker;
            });

            clusterer.addMarkers(markers);
        })
        .catch(error => console.error('Error fetching academies:', error));
    }

    function filterMarkers(category) {
        selectedCategory = category;
        fetchAcademies(); // 새 데이터 로드
    }

    function showAcademyInfo(data) {
        var infoList = document.getElementById('academyInfo');
        infoList.innerHTML = `
            <li>
                <strong>
                    <a href="/academy/${data.id}">${data.상호명}</a>
                </strong>
            </li>
            <li><strong>도로명주소:</strong> ${data.도로명주소}</li>
            <li><strong>전화번호:</strong> ${data.전화번호}</li>
            <li><strong>학원 종류:</strong> ${data.학원_종류}</li>
        `;
    }

    // 현 위치로 이동 버튼 동작
    function moveToCurrentLocation() {
        if (currentLocation) {
            map.setCenter(currentLocation); // 지도를 현재 위치로 이동
            map.setLevel(4); // 적절한 줌 레벨로 조정
        } else {
            alert('현재 위치를 가져올 수 없습니다.');
        }
    }

    function getCSRFToken() {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length);
            }
        }
        return '';
    }
</script>



</body>
</html>
