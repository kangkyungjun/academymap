{% extends "templates/main/base.html" %}
{% load static %}
{% load humanize %}
{% block contents %}

<div class="navbar">
  <button class="nav_item1" onclick="agetogglePanel()">연령</button>
  <a href="{% url 'search' %}" class="nav_item2">
    <div class="search_box">학원명/지역 검색</div>
    <div class="search_icon_box"><span class="material-symbols-outlined">search</span></div>
  </a>
  <!-- Toggle Panel Button -->
  <button class="nav_item3" id="toggle-panel" onclick="togglePanel()"><span class="material-symbols-outlined">payments</span></br>수강료</button>
</div>

<!-- 패널(콘텐츠 영역): 가격 범위 필터 (noUiSlider 적용) -->
<div id="panel-container" style="display: none; padding: 1rem; background-color: #fff;">
  <!-- 슬라이더 영역 -->
  <div id="price-slider" style="margin: 1rem 0;"></div>
  <div>
    <span id="price-slider-min"></span> - <span id="price-slider-max"></span>
  </div>
  <!-- 선택된 값 저장용 hidden input -->
  <input type="hidden" id="price-min" value="{{ min_price }}">
  <input type="hidden" id="price-max" value="{{ max_price }}">
  <button onclick="applyPriceFilter()" style="margin-top: 10px;">적용</button>
</div>


<!-- 카테고리 버튼 (가로 스크롤) -->
<div id="category-container">
  <div id="category">
    <button onclick="filterMarkers(this, '전체')">전체</button>
    <button onclick="filterMarkers(this, '수학')">수학</button>
    <button onclick="filterMarkers(this, '영어')">영어</button>
    <button onclick="filterMarkers(this, '과학')">과학</button>
    <button onclick="filterMarkers(this, '외국어')">외국어</button>
    <button onclick="filterMarkers(this, '예체능')">예체능</button>
    <button onclick="filterMarkers(this, '컴퓨터')">컴퓨터</button>
    <button onclick="filterMarkers(this, '논술')">논술</button>
    <button onclick="filterMarkers(this, '기타')">기타</button>
    <button onclick="filterMarkers(this, '독서실/스터디카페')">독서실/스터디카페</button>
  </div>
</div>

<!-- 지도 영역 -->
<div id="map"></div>

<!-- 내 위치 버튼 -->
<div id="controls">
  <button onclick="moveToCurrentLocation()">
    <span class="material-symbols-outlined">my_location</span>
  </button>
</div>

<!-- 학원 정보 팝업 -->
<div id="academyPopup" class="popup">
  <div id="popupContent"></div>
  <button onclick="closePopup()">닫기</button>
</div>



<!-- noUiSlider CSS, JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

<script>
  // Block 1: Global Variables and Utility Functions
  let map, markers = [];
  let selectedCategory = '전체';
  let currentMarker = null;
  let allAcademyData = [];
  let markerBoxes = [];
  let slider;  // 가격 필터용 슬라이더 인스턴스를 저장할 전역 변수

  const categoryColors = {
    '종합': '#000000',
    '수학': '#FF0000',
    '영어': '#0000FF',
    '과학': '#008000',
    '외국어': '#800080',
    '예체능': '#FFA500',
    '컴퓨터': '#FFC0CB',
    '논술': '#8B4513',
    '기타': '#808080',
    '독서실/스터디카페': '#00CED1'
  };

  function getShortAddress(address) {
    if (!address) return "";
    const parts = address.split(" ");
    if (parts.length >= 3) {
      return parts.slice(2).join(" ");
    }
    return address;
  }

  function getAcademyType(ac) {
    const name = ac.상호명;
    if (name.indexOf('수학') !== -1) return '수학';
    if (name.indexOf('영어') !== -1) return '영어';
    if (name.indexOf('과학') !== -1) return '과학';
    if (name.indexOf('외국어') !== -1) return '외국어';
    if (name.indexOf('예체능') !== -1) return '예체능';
    if (name.indexOf('컴퓨터') !== -1) return '컴퓨터';
    if (name.indexOf('논술') !== -1) return '논술';
    if (name.indexOf('독서실') !== -1 || name.indexOf('스터디카페') !== -1)
      return '독서실/스터디카페';
    if (name.indexOf('종합') !== -1) return '종합';
    return '기타';
  }

  function easeInOutQuad(t) {
    return t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
  }

  function smoothZoom(targetZoom, duration) {
    let startZoom = map.getZoom();
    let startTime = performance.now();
    function animateZoom() {
      let now = performance.now();
      let elapsed = now - startTime;
      let t = Math.min(elapsed / duration, 1);
      let newZoom = startZoom + (targetZoom - startZoom) * easeInOutQuad(t);
      map.setZoom(newZoom);
      if(t < 1) {
        requestAnimationFrame(animateZoom);
      }
    }
    requestAnimationFrame(animateZoom);
  }
</script>


<script>
  // Block 2: Map Initialization and Custom Zoom Control
  function initMap() {
    navigator.geolocation.getCurrentPosition(pos => {
      const userLoc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      // 기본 줌 컨트롤 비활성화 → 커스텀 컨트롤 사용
      map = new naver.maps.Map('map', {
        center: userLoc,
        zoom: 17,
        minZoom: 7,
        zoomControl: false
      });
      currentMarker = new naver.maps.Marker({
        position: userLoc,
        map: map,
        icon: {
          content: '<div style="width:18px;height:18px;background-color:red;border-radius:50%;border:3px solid white;"></div>',
          anchor: new naver.maps.Point(7.5, 7.5)
        }
      });
      fetchAcademies();
      naver.maps.Event.addListener(map, 'idle', fetchAcademies);
      // 커스텀 줌 컨트롤 생성 (세로 슬라이더 바 형태: 상단 "+" / 중앙 슬라이더 / 하단 "–")
      createCustomZoomControl();
    }, err => {
      const defaultLoc = new naver.maps.LatLng(37.5665, 126.9780);
      map = new naver.maps.Map('map', {
        center: defaultLoc,
        zoom: 17,
        minZoom: 7,
        zoomControl: false
      });
      fetchAcademies();
      createCustomZoomControl();
    });
  }

  function createCustomZoomControl() {
    const zoomControlContainer = document.createElement('div');
    zoomControlContainer.style.position = 'absolute';
    zoomControlContainer.style.bottom = '13rem';      // 원하는 위치 (픽셀 단위)
    zoomControlContainer.style.right = '3rem';         // 원하는 위치 (픽셀 단위)
    zoomControlContainer.style.display = 'flex';
    zoomControlContainer.style.flexDirection = 'column'; // 세로 배치
    zoomControlContainer.style.alignItems = 'center';
    zoomControlContainer.style.backgroundColor = '#fff';
    zoomControlContainer.style.border = '1px solid #ccc';
    zoomControlContainer.style.borderRadius = '0.5rem';
    zoomControlContainer.style.padding = '5px';
    zoomControlContainer.style.zIndex = '1';

    // "+" 버튼 (상단)
    const zoomPlus = document.createElement('button');
    zoomPlus.id = 'zoomPlus';
    zoomPlus.innerText = '+';
    zoomPlus.style.marginBottom = '5px';
    zoomControlContainer.appendChild(zoomPlus);

    // 슬라이더 요소 (중앙) - 세로 슬라이더: 높이와 좁은 너비 설정
    const zoomSlider = document.createElement('div');
    zoomSlider.id = 'zoom-slider';
    zoomSlider.style.height = '150px'; // 슬라이더 높이
    zoomSlider.style.width = '20px';   // 슬라이더 너비
    zoomControlContainer.appendChild(zoomSlider);

    // "–" 버튼 (하단)
    const zoomMinus = document.createElement('button');
    zoomMinus.id = 'zoomMinus';
    zoomMinus.innerText = '–';
    zoomMinus.style.marginTop = '5px';
    zoomControlContainer.appendChild(zoomMinus);

    document.getElementById('map').appendChild(zoomControlContainer);

    // 줌 범위 설정 (맵의 최소/최대 줌; 기본 7~20)
    const minZoom = map.getMinZoom ? map.getMinZoom() : 7;
    const maxZoom = map.getMaxZoom ? map.getMaxZoom() : 20;
    const currentZoom = map.getZoom();

    noUiSlider.create(zoomSlider, {
      start: [currentZoom],
      connect: [true, false],
      step: 1,
      orientation: 'vertical', // 세로 슬라이더
      direction: 'rtl',        // 'rtl' 옵션을 추가하면 슬라이더 방향이 반전되어, 아래에서 위로 올리면 값이 증가합니다.
      range: {
        'min': minZoom,
        'max': maxZoom
      },
      tooltips: true,
      format: {
        to: function(value) { return Math.round(value).toString(); },
        from: function(value) { return Number(value); }
      }
    });

    zoomSlider.noUiSlider.on('update', function(values, handle) {
      const newZoom = Number(values[handle]);
      if (map.getZoom() !== newZoom) {
        map.setZoom(newZoom);
      }
    });

    zoomPlus.addEventListener('click', function() {
      let currentVal = Number(zoomSlider.noUiSlider.get());
      if (currentVal < maxZoom) {
        zoomSlider.noUiSlider.set(currentVal + 1);
      }
    });

    zoomMinus.addEventListener('click', function() {
      let currentVal = Number(zoomSlider.noUiSlider.get());
      if (currentVal > minZoom) {
        zoomSlider.noUiSlider.set(currentVal - 1);
      }
    });
  }

  naver.maps.onJSContentLoaded = initMap;
</script>


<script>
  // Block 3: Academy Data Fetching and Marker Rendering Functions
  function fetchAcademies() {
    const bounds = map.getBounds();
    const sw = bounds.getSW();
    const ne = bounds.getNE();

    // 가격 범위 필터 값 가져오기
    let priceMin = document.getElementById('price-min') ? document.getElementById('price-min').value : "";
    let priceMax = document.getElementById('price-max') ? document.getElementById('price-max').value : "";

    fetch('/api/filtered_academies', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        swLat: sw._lat,
        swLng: sw._lng,
        neLat: ne._lat,
        neLng: ne._lng,
        category: selectedCategory,
        priceMin: priceMin,
        priceMax: priceMax
      })
    })
    .then(res => res.json())
    .then(data => {
      allAcademyData = data;
      renderMarkers();
    })
    .catch(error => console.error('학원 데이터 요청 에러:', error));
  }

  function renderMarkers() {
    clearMarkers();
    const zoomLevel = map.getZoom();
    if (zoomLevel < 16) {
      const grouped = {};
      allAcademyData.forEach(ac => {
        const regionKey = ac.시군구명 || '기타';
        if (!grouped[regionKey]) grouped[regionKey] = [];
        grouped[regionKey].push(ac);
      });
      for (const region in grouped) {
        const arr = grouped[region];
        if (arr.length === 0) continue;
        const rep = arr[0];
        const markerContent = `
          <div style="min-width:60px; padding:3px 5px; background-color:#333; color:#fff; border-radius:4px; font-size:20px; font-weight:bold; text-align:center;">
            ${region} (${arr.length})
          </div>
        `;
        placeMarkerNoOverlap(rep.위도, rep.경도, markerContent, region);
      }
    } else {
      let groupedByAddress = {};
      allAcademyData.forEach(ac => {
        const address = ac.도로명주소 || "unknown";
        if (!groupedByAddress[address]) {
          groupedByAddress[address] = [];
        }
        groupedByAddress[address].push(ac);
      });
      for (let address in groupedByAddress) {
        let group = groupedByAddress[address];
        if (group.length === 1) {
          let ac = group[0];
          let markerContent = generateAcademyMarkerContent(ac);
          placeMarkerAt(ac.위도, ac.경도, markerContent, ac);
        } else {
          let representative = group[0];
          let bubbleContent = generateBubbleMarkerContent(group);
          placeBubbleMarker(representative.위도, representative.경도, bubbleContent, group);
        }
      }
    }
  }

  function placeMarkerAt(lat, lng, content, dataObj) {
    let marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: map,
      icon: { content: content, anchor: new naver.maps.Point(10, 10) },
      title: (typeof dataObj === 'object' && dataObj.상호명) ? dataObj.상호명 : ''
    });
    naver.maps.Event.addListener(marker, 'click', function(){
      showAcademyInfoPopup(dataObj);
    });
    markers.push(marker);
  }

  function placeBubbleMarker(lat, lng, content, group) {
    let marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: map,
      icon: { content: content, anchor: new naver.maps.Point(10, 10) },
      title: group.length + "개 학원"
    });
    naver.maps.Event.addListener(marker, 'click', function(){
      showGroupPopup(group, marker.getPosition());
    });
    markers.push(marker);
  }

  function placeMarkerNoOverlap(lat, lng, content, dataObj) {
    const proj = map.getProjection();
    let screenPt = proj.fromCoordToOffset(new naver.maps.LatLng(lat, lng));
    const markerW = 60, markerH = 24;
    let overlapped = true;
    const MAX_ATTEMPTS = 50;
    let attempts = 0;
    while (overlapped && attempts < MAX_ATTEMPTS) {
      overlapped = false;
      for (let b of markerBoxes) {
        if (Math.abs(screenPt.x - b.x) < markerW && Math.abs(screenPt.y - b.y) < markerH) {
          overlapped = true;
          screenPt.y += markerH + 2;
          break;
        }
      }
      attempts++;
    }
    const finalCoord = proj.fromOffsetToCoord(screenPt);
    const marker = new naver.maps.Marker({
      position: finalCoord,
      map: map,
      icon: { content: content, anchor: new naver.maps.Point(10, 10) },
      title: (typeof dataObj === 'object' && dataObj.상호명) ? dataObj.상호명 : ''
    });
    naver.maps.Event.addListener(marker, 'click', function() {
      if (typeof dataObj === 'object' && dataObj.id) {
        showAcademyInfoPopup(dataObj);
      } else if (typeof dataObj === 'string') {
        let targetZoom = map.getZoom() + 1;
        map.panTo(marker.getPosition(), { duration: 500 });
        smoothZoom(targetZoom, 500);
      }
    });
    markers.push(marker);
    markerBoxes.push({ x: screenPt.x, y: screenPt.y, w: markerW, h: markerH });
  }

  function generateAcademyMarkerContent(ac) {
    if (selectedCategory === '전체') {
      const academyType = getAcademyType(ac);
      const color = categoryColors[academyType] || 'blue';
      return `
        <div style="display:flex; flex-direction:column; align-items:center;">
          <div style="width:15px; height:15px; background-color:${color}; border:2px solid white; border-radius:50%; margin-bottom:2px;"></div>
          <span style="font-size:13px; font-weight:bold; padding:2px 4px; border-radius:4px;">${ac.상호명}</span>
        </div>
      `;
    } else {
      const color = categoryColors[selectedCategory];
      return `
        <div style="display:flex; flex-direction:column; align-items:center;">
          <div style="width:15px; height:15px; background-color:${color}; border:2px solid white; border-radius:50%; margin-bottom:2px;"></div>
          <span style="font-size:13px; font-weight:bold; padding:2px 4px; border-radius:4px;">${ac.상호명}</span>
        </div>
      `;
    }
  }

  function generateBubbleMarkerContent(group) {
    let count = group.length;
    let shortAddress = getShortAddress(group[0].도로명주소);
    let repType = getAcademyType(group[0]);
    let color = categoryColors[repType] || "#ff5733";
    let content = `
      <div style="position: relative; display: inline-block;">
        <div style="background-color: ${color}; color: white; border-radius: 10px; padding: 5px 10px; font-size: 12px; text-align: center;">
          ${shortAddress}<br/>(${count}개 학원)
        </div>
        <div style="position: absolute; left: 50%; transform: translateX(-50%); top: 100%;">
          <div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid ${color};"></div>
        </div>
      </div>
    `;
    return content;
  }

  function showGroupPopup(group, position) {
    const popup = document.getElementById('academyPopup');
    const popupContent = document.getElementById('popupContent');
    let shortAddress = getShortAddress(group[0].도로명주소);
    let content = `<h3>${shortAddress} (${group.length}개 학원)</h3><ul>`;
    group.forEach(ac => { content += `<li><a href="/academy/${ac.id}">${ac.상호명}</a></li>`; });
    content += `</ul>`;
    popupContent.innerHTML = content;
    popup.classList.add('active');
  }

  function showAcademyInfoPopup(academy) {
    const popup = document.getElementById('academyPopup');
    const popupContent = document.getElementById('popupContent');
    popupContent.innerHTML = `
      <h3><a href="/academy/${academy.id}">${academy.상호명}</a></h3>
      <p><strong>전화번호:</strong> ${academy.전화번호 || '정보 없음'}</p>
      <p><strong>주소:</strong> ${academy.도로명주소 || '정보 없음'}</p>
    `;
    popup.classList.add('active');
  }

  function closePopup() {
    document.getElementById('academyPopup').classList.remove('active');
  }

  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerBoxes = [];
  }

  function filterMarkers(btn, category) {
    selectedCategory = category;
    const buttons = document.querySelectorAll('#category button');
    buttons.forEach(button => button.classList.remove('active'));
    btn.classList.add('active');
    fetchAcademies();
  }

  function moveToCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLoc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        map.setCenter(userLoc);
        map.setZoom(17);
        if (currentMarker) {
          currentMarker.setPosition(userLoc);
        } else {
          currentMarker = new naver.maps.Marker({
            position: userLoc,
            map: map,
            icon: {
              content: '<div style="width:15px;height:15px;background-color:red;border-radius:50%;border:2px solid white;"></div>',
              anchor: new naver.maps.Point(7.5, 7.5)
            }
          });
        }
      }, () => { alert('위치 정보를 가져올 수 없습니다.'); });
    } else { alert('이 브라우저는 위치 정보를 지원하지 않습니다.'); }
  }

  function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith('csrftoken=')) {
        return cookie.substring('csrftoken='.length);
      }
    }
    return '';
  }
</script>

<script>
  // Block 4: 수강료! Price Filter Slider Initialization and Panel Toggling
  function togglePanel() {
    var panel = document.getElementById("panel-container");
    if (panel.style.display === "none" || panel.style.display === "") {
      panel.style.display = "block";
    } else {
      panel.style.display = "none";
    }
  }

  function applyPriceFilter() {
    // 패널을 숨기고 가격 필터 기준으로 학원 데이터를 새로 요청
    document.getElementById("panel-container").style.display = "none";
    fetchAcademies();
  }

  document.addEventListener('DOMContentLoaded', function() {
    var slider = document.getElementById('price-slider');
    var minPrice = parseFloat("{{ min_price|default:0 }}");
    var maxPrice = parseFloat("{{ max_price|default:100 }}");
    var initialMin = parseFloat(document.getElementById('price-min').value) || minPrice;
    var initialMax = parseFloat(document.getElementById('price-max').value) || maxPrice;

    noUiSlider.create(slider, {
      start: [initialMin, initialMax],
      connect: true,
      orientation: 'vertical',  // 세로 슬라이더로 전환
      direction: 'rtl',         // 수직 슬라이더를 반전: 낮은 값은 아래, 높은 값은 위로
      range: {
        'min': minPrice,
        'max': maxPrice
      },
      tooltips: [true, true],
      format: {
        to: function(value) { return Math.round(value).toLocaleString(); },
        from: function(value) { return Number(value.toString().replace(/,/g, '')); }
      }
    });

    slider.noUiSlider.on('update', function(values, handle) {
      document.getElementById('price-slider-min').innerText = values[0] + "원";
      document.getElementById('price-slider-max').innerText = values[1] + "원";
      document.getElementById('price-min').value = values[0].replace(/,/g, '');
      document.getElementById('price-max').value = values[1].replace(/,/g, '');
    });
  });
</script>




{% endblock %}
