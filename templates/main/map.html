{% extends "templates/main/base.html" %}
{% load static %}
{% block contents %}
{% load humanize %}


  <div id="navbar">
    <!-- 검색 아이콘 (왼상단) -->
    <div class="search-icon">
      <a href="{% url 'academy_list' %}"><span class="material-symbols-outlined" style="font-size:1.8rem;">search</span></a>
    </div>
  </div>



  <!-- 카테고리 버튼 (가로 스크롤) -->
  <div id="category-container">
    <div id="category">
      <button onclick="filterMarkers('전체')">전체</button>
      <button onclick="filterMarkers('수학')">수학</button>
      <button onclick="filterMarkers('영어')">영어</button>
      <button onclick="filterMarkers('과학')">과학</button>
      <button onclick="filterMarkers('외국어')">외국어</button>
      <button onclick="filterMarkers('예체능')">예체능</button>
      <button onclick="filterMarkers('컴퓨터')">컴퓨터</button>
      <button onclick="filterMarkers('논술')">논술</button>
      <button onclick="filterMarkers('기타')">기타</button>
      <button onclick="filterMarkers('독서실/스터디카페')">독서실/스터디카페</button>
    </div>
  </div>

  <!-- 지도 영역 -->
  <div id="map"></div>

  <!-- 내 위치 버튼 -->
  <div id="controls">
    <button onclick="moveToCurrentLocation()">
      <span class="material-symbols-outlined">my_location</span>
    </button>
  </div>

  <!-- 학원 정보 팝업 -->
  <div id="academyPopup" class="popup">
    <div id="popupContent"></div>
    <button onclick="closePopup()">닫기</button>
  </div>
</div>
<script>
/*
  전역 변수
  - map: 지도 객체
  - markers: 현재 지도에 표시 중인 (실제) 마커 배열
  - selectedCategory: 카테고리 필터
  - currentMarker: 내 위치 마커
  - allAcademyData: 서버에서 받아온 학원 데이터 (지도 범위 내)
  - markerBoxes: 현재 표시된 마커들의 "화면 좌표 Bounding Box" 목록 (겹침 방지용)
*/
let map, markers = [];
let selectedCategory = '전체';
let currentMarker = null;
let allAcademyData = [];
let markerBoxes = []; // {x, y, w, h} 형식으로 저장, 겹침 감지

// 과목별 색상
const categoryColors = {
  '수학': '#FF0000',
  '영어': '#0000FF',
  '과학': '#008000',
  '외국어': '#800080',
  '예체능': '#FFA500',
  '컴퓨터': '#FFC0CB',
  '논술': '#8B4513',
  '기타': '#808080',
  '독서실/스터디카페': '#00CED1',
};

// 지도 초기화
function initMap() {
  navigator.geolocation.getCurrentPosition(pos => {
    const userLoc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
    map = new naver.maps.Map('map', {
      center: userLoc,
      zoom: 17,
      minZoom: 11,
      zoomControl: false
    });

    // 내 위치 마커
    currentMarker = new naver.maps.Marker({
      position: userLoc,
      map: map,
      icon: {
        content: '<div style="width:18px;height:18px;background-color:red;border-radius:50%;border:3px solid white;"></div>',
        anchor: new naver.maps.Point(7.5, 7.5)
      }
    });

    fetchAcademies();
    naver.maps.Event.addListener(map, 'idle', fetchAcademies);

  }, err => {
    const defaultLoc = new naver.maps.LatLng(37.5665, 126.9780);
    map = new naver.maps.Map('map', {
      center: defaultLoc,
      zoom: 17,
      minZoom: 11,
      zoomControl: false
    });
    fetchAcademies();
  });
}

// 서버에서 학원 데이터 (현재 범위 + 카테고리) 가져오기
function fetchAcademies() {
  const bounds = map.getBounds();
  const sw = bounds.getSW();
  const ne = bounds.getNE();

  fetch('/api/filtered_academies', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify({
      swLat: sw._lat,
      swLng: sw._lng,
      neLat: ne._lat,
      neLng: ne._lng,
      category: selectedCategory
    })
  })
  .then(res => res.json())
  .then(data => {
    allAcademyData = data;
    renderMarkers();
  })
  .catch(error => console.error('Error:', error));
}

// 지역 vs 개별 학원 (간단 구현) - zoom 레벨 16 기준
function renderMarkers() {
  clearMarkers();

  const zoomLevel = map.getZoom();
  if (zoomLevel < 16) {
    // 시군구명으로 그룹핑
    const grouped = {};
    allAcademyData.forEach(ac => {
      const regionKey = ac.시군구명 || '기타';
      if (!grouped[regionKey]) grouped[regionKey] = [];
      grouped[regionKey].push(ac);
    });

    for (const region in grouped) {
      const arr = grouped[region];
      if (arr.length === 0) continue;
      const rep = arr[0]; // 대표로 첫 번째
      const markerContent = `
        <div style="
          min-width:60px; padding:3px 5px;
          background-color:#333; color:#fff;
          border-radius:4px; font-size:20px;
          font-weight:bold; text-align:center;
        ">
          ${region} (${arr.length})
        </div>
      `;
      placeMarkerNoOverlap(rep.위도, rep.경도, markerContent, region);
    }

  } else {
    // 개별 학원 표시
    allAcademyData.forEach(ac => {
      const category = ac.category;
      const color = categoryColors[category] || null;

      let markerContent;
      if (color) {
        markerContent = `
          <div style="
            min-width:60px;
            padding:3px 5px;
            background-color:${color};
            color:white;
            border-radius:4px;
            font-size:12px;
            font-weight:bold;
            text-align:center;
          ">
            ${ac.상호명}
          </div>
        `;
      } else {
        markerContent = `
          <div style="
            display:flex;
            flex-direction:column;
            align-items:center;
          ">
            <div style="
              width:15px;
              height:15px;
              background-color:blue;
              border:2px solid white;
              border-radius:50%;
              margin-bottom:2px;
            "></div>
            <span style="
              font-size:13px;
              font-weight:bold;
              padding:2px 4px;
              border-radius:4px;
            ">
              ${ac.상호명}
            </span>
          </div>
        `;
      }

      placeMarkerNoOverlap(ac.위도, ac.경도, markerContent, ac);
    });
  }
}

/**
 * 겹치지 않게 마커 배치
 * 1) 지도 좌표 -> 화면 좌표 변환
 * 2) 이미 사용 중인 box들과 겹치면 y 좌표를 조금씩 내려서 회피
 * 3) 최종 화면 좌표 -> 지도 좌표 역변환 -> Marker 생성
 */
function placeMarkerNoOverlap(lat, lng, content, dataObj) {
  // 1) 지도 -> 화면 좌표
  const proj = map.getProjection();
  let screenPt = proj.fromCoordToOffset(new naver.maps.LatLng(lat, lng));

  // 마커 박스 크기(가정)
  const markerW = 60, markerH = 24;
  // 만약 상호명이 긴 경우 좀 더 넉넉히 잡을 수도 있음

  // 2) 기존 마커와 겹치지 않을 때까지 반복
  let overlapped = true;
  const MAX_ATTEMPTS = 50; // 무한루프 방지
  let attempts = 0;
  while (overlapped && attempts < MAX_ATTEMPTS) {
    overlapped = false;
    for (let b of markerBoxes) {
      // 충돌 여부 체크 (간단 AABB 충돌)
      if (Math.abs(screenPt.x - b.x) < (markerW) &&
          Math.abs(screenPt.y - b.y) < (markerH)) {
        // 겹침
        overlapped = true;
        // Y 좌표를 약간 아래로 밀어본다 (또는 x+random 등)
        screenPt.y += markerH + 2;
        break;
      }
    }
    attempts++;
  }

  // 3) 최종 화면 좌표 -> 지도 좌표
  const finalCoord = proj.fromOffsetToCoord(screenPt);

  const marker = new naver.maps.Marker({
    position: finalCoord,
    map: map,
    icon: {
      content: content,
      anchor: new naver.maps.Point(10, 10)
    },
    // dataObj가 시군구명 등이면 title에 써도 좋고,
    // academy 객체면 academy.상호명 등
    title: (typeof dataObj === 'object' && dataObj.상호명) ? dataObj.상호명 : ''
  });

  // 클릭 이벤트 (팝업)
  naver.maps.Event.addListener(marker, 'click', function() {
    if (typeof dataObj === 'object' && dataObj.id) {
      showAcademyInfoPopup(dataObj);
    }
  });

  markers.push(marker);

  // 새로 배치한 마커 박스 등록
  markerBoxes.push({
    x: screenPt.x,
    y: screenPt.y,
    w: markerW,
    h: markerH
  });
}

function showAcademyInfoPopup(academy) {
  const popup = document.getElementById('academyPopup');
  const popupContent = document.getElementById('popupContent');

  popupContent.innerHTML = `
    <h3><a href="/academy/${academy.id}">${academy.상호명}</a></h3>
    <p><strong>전화번호:</strong> ${academy.전화번호 || '정보 없음'}</p>
    <p><strong>주소:</strong> ${academy.도로명주소 || '정보 없음'}</p>
  `;
  popup.classList.add('active');
}

function closePopup() {
  document.getElementById('academyPopup').classList.remove('active');
}

// 모든 마커 지우기 + markerBoxes 초기화
function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
  markerBoxes = [];
}

function filterMarkers(category) {
  selectedCategory = category;
  fetchAcademies();
}

function moveToCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userLoc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(userLoc);
      map.setZoom(17);
      if (currentMarker) {
        currentMarker.setPosition(userLoc);
      } else {
        currentMarker = new naver.maps.Marker({
          position: userLoc,
          map: map,
          icon: {
            content: '<div style="width:15px;height:15px;background-color:red;border-radius:50%;border:2px solid white;"></div>',
            anchor: new naver.maps.Point(7.5, 7.5)
          }
        });
      }
    }, () => {
      alert('위치 정보를 가져올 수 없습니다.');
    });
  } else {
    alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
  }
}

function getCSRFToken() {
  const cookies = document.cookie.split(';');
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i].trim();
    if (cookie.startsWith('csrftoken=')) {
      return cookie.substring('csrftoken='.length);
    }
  }
  return '';
}

// 지도 로드 후 initMap
naver.maps.onJSContentLoaded = initMap;
</script>

{% endblock %}