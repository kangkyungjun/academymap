{% extends "templates/main/base.html" %}
{% load static %}
{% load humanize %}
{% block contents %}
<style>
  html, body {
    overflow: hidden;
  }
</style>
<div class="navbar" style="padding-right: 0;">
  <button class="nav_item1" onclick="window.location.href='javascript:history.back()'"><span class="material-symbols-outlined">arrow_back_ios</span></button>
  <a href="{% url 'search' %}" class="nav_item2">
    <div class="search_box">í•™ì›ëª…/ì§€ì—­ ê²€ìƒ‰</div>
    <div class="search_icon_box"><span class="material-symbols-outlined">search</span></div>
  </a>
    <!-- Toggle Panel Button -->
  <div class="nav_item3">
    <button class="account" style="display:none;"><span class="material-symbols-outlined">person</span></button>
    <button class="filterButton" id="toggle-panel" onclick="togglePanel()"><span class="material-symbols-outlined">tune</span></button>
  </div>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ (ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
<div id="category-container">
  <div id="category">
    <button onclick="filterMarkers(this, 'ì „ì²´')">ì „ì²´</button>
    <button onclick="filterMarkers(this, 'ìˆ˜í•™')">ìˆ˜í•™</button>
    <button onclick="filterMarkers(this, 'ì˜ì–´')">ì˜ì–´</button>
    <button onclick="filterMarkers(this, 'ê³¼í•™')">ê³¼í•™</button>
    <button onclick="filterMarkers(this, 'ì™¸êµ­ì–´')">ì™¸êµ­ì–´</button>
    <button onclick="filterMarkers(this, 'ì˜ˆì²´ëŠ¥')">ì˜ˆì²´ëŠ¥</button>
    <button onclick="filterMarkers(this, 'ì»´í“¨í„°')">ì»´í“¨í„°</button>
    <button onclick="filterMarkers(this, 'ë…¼ìˆ ')">ë…¼ìˆ </button>
    <button onclick="filterMarkers(this, 'ê¸°íƒ€')">ê¸°íƒ€</button>
    <button onclick="filterMarkers(this, 'ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜')">ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜</button>
  </div>
</div>

<div id="panel-container">
  <div class="panel-subject-title">ê³¼ëª©</div>
  <div id="panel-category">
    <button onclick="filterMarkers(this, 'ì „ì²´')">ì „ì²´</button>
    <button onclick="filterMarkers(this, 'ìˆ˜í•™')">ìˆ˜í•™</button>
    <button onclick="filterMarkers(this, 'ì˜ì–´')">ì˜ì–´</button>
    <button onclick="filterMarkers(this, 'ê³¼í•™')">ê³¼í•™</button>
    <button onclick="filterMarkers(this, 'ì™¸êµ­ì–´')">ì™¸êµ­ì–´</button>
    <button onclick="filterMarkers(this, 'ì˜ˆì²´ëŠ¥')">ì˜ˆì²´ëŠ¥</button>
    <button onclick="filterMarkers(this, 'ì»´í“¨í„°')">ì»´í“¨í„°</button>
    <button onclick="filterMarkers(this, 'ë…¼ìˆ ')">ë…¼ìˆ </button>
    <button onclick="filterMarkers(this, 'ê¸°íƒ€')">ê¸°íƒ€</button>
    <button onclick="filterMarkers(this, 'ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜')">ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜</button>
  </div>

  <hr>

  <!-- ê°€ê²© í•„í„°: ìŠ¬ë¼ì´ë” ì˜ì—­ -->
  <div>
    ìˆ˜ê°•ë£Œ
    <div class="price-part">
      <span id="price-slider-min"></span>  -  <span id="price-slider-max"></span>
    </div>

  </div>
  <div id="price-slider"></div>
  <!-- ì„ íƒëœ ê°’ ì €ì¥ìš© hidden input -->
  <input type="hidden" id="price-min" value="{{ min_price }}">
  <input type="hidden" id="price-max" value="{{ max_price }}">

   <hr>

  <div class="panel-age-title">ì—°ë ¹</div>
    <!-- ì—°ë ¹ í•„í„° ë²„íŠ¼ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥) -->
  <div class="panel-age-filters">
    <button class="age-filter" onclick="toggleAgeFilter('ìœ ì•„', this)">ìœ ì•„</button>
    <button class="age-filter" onclick="toggleAgeFilter('ì´ˆë“±', this)">ì´ˆë“±</button>
    <button class="age-filter" onclick="toggleAgeFilter('ì¤‘ë“±', this)">ì¤‘ë“±</button>
    <button class="age-filter" onclick="toggleAgeFilter('ê³ ë“±', this)">ê³ ë“±</button>
    <button class="age-filter" onclick="toggleAgeFilter('íŠ¹ëª©ê³ ', this)">íŠ¹ëª©ê³ </button>
    <button class="age-filter" onclick="toggleAgeFilter('ì¼ë°˜', this)">ì¼ë°˜</button>
    <button class="age-filter" onclick="toggleAgeFilter('ê¸°íƒ€', this)">ê¸°íƒ€</button>
  </div>

   <hr>

    <!-- íŒ¨ë„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€, ì—°ë ¹ í•„í„° ì•„ë˜ì— ì¶”ê°€ -->
  <div class="panel-suttle-title">ì…”í‹€</div>
  <div class="panel-suttle-filters">
    <button class="suttle-filter" onclick="toggleShuttleFilter(this)">ì…”í‹€ë²„ìŠ¤</button>
  </div>

</div>


<!-- ì§€ë„ ì˜ì—­ -->
<div id="map"></div>

<!-- ë‚´ ìœ„ì¹˜ ë²„íŠ¼ -->
<div id="controls">
  <button onclick="moveToCurrentLocation()">
    <span class="material-symbols-outlined">my_location</span>
  </button>
</div>

<!-- í•™ì› ì •ë³´ íŒì—… -->
<div id="academyPopup" class="popup">
  <div id="popupContent"></div>
  <button onclick="closePopup()">ë‹«ê¸°</button>
</div>





<!-- noUiSlider CSS, JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

<script>
  // Block 1: ì „ì—­ ë³€ìˆ˜ ê°’ ì„¤ì •
  let map, markers = [];
  let selectedCategory = 'ì „ì²´';
  let currentMarker = null;
  let allAcademyData = [];
  let markerBoxes = [];
  let slider;  // ê°€ê²© í•„í„°ìš© ìŠ¬ë¼ì´ë” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

  const categoryColors = {
    'ì¢…í•©': '#000000',
    'ìˆ˜í•™': '#FF0000',
    'ì˜ì–´': '#0000FF',
    'ê³¼í•™': '#008000',
    'ì™¸êµ­ì–´': '#800080',
    'ì˜ˆì²´ëŠ¥': '#FFA500',
    'ì»´í“¨í„°': '#FFC0CB',
    'ë…¼ìˆ ': '#8B4513',
    'ê¸°íƒ€': '#808080',
    'ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜': '#00CED1'
  };

  function getShortAddress(address) {
    if (!address) return "";
    const parts = address.split(" ");
    if (parts.length >= 3) {
      return parts.slice(2).join(" ");
    }
    return address;
  }

  function getAcademyType(ac) {
    const name = ac.ìƒí˜¸ëª…;
    if (name.indexOf('ìˆ˜í•™') !== -1) return 'ìˆ˜í•™';
    if (name.indexOf('ì˜ì–´') !== -1) return 'ì˜ì–´';
    if (name.indexOf('ê³¼í•™') !== -1) return 'ê³¼í•™';
    if (name.indexOf('ì™¸êµ­ì–´') !== -1) return 'ì™¸êµ­ì–´';
    if (name.indexOf('ì˜ˆì²´ëŠ¥') !== -1) return 'ì˜ˆì²´ëŠ¥';
    if (name.indexOf('ì»´í“¨í„°') !== -1) return 'ì»´í“¨í„°';
    if (name.indexOf('ë…¼ìˆ ') !== -1) return 'ë…¼ìˆ ';
    if (name.indexOf('ë…ì„œì‹¤') !== -1 || name.indexOf('ìŠ¤í„°ë””ì¹´í˜') !== -1)
      return 'ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜';
    if (name.indexOf('ì¢…í•©') !== -1) return 'ì¢…í•©';
    return 'ê¸°íƒ€';
  }

  function easeInOutQuad(t) {
    return t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
  }

  function smoothZoom(targetZoom, duration) {
    let startZoom = map.getZoom();
    let startTime = performance.now();
    function animateZoom() {
      let now = performance.now();
      let elapsed = now - startTime;
      let t = Math.min(elapsed / duration, 1);
      let newZoom = startZoom + (targetZoom - startZoom) * easeInOutQuad(t);
      map.setZoom(newZoom);
      if(t < 1) {
        requestAnimationFrame(animateZoom);
      }
    }
    requestAnimationFrame(animateZoom);
  }
</script>

<script>
  // Block 2: Map Initialization and Custom Zoom Control
  function initMap() {
    navigator.geolocation.getCurrentPosition(pos => {
      const userLoc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      // ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™” â†’ ì»¤ìŠ¤í…€ ì»¨íŠ¸ë¡¤ ì‚¬ìš©
      map = new naver.maps.Map('map', {
        center: userLoc,
        zoom: 17,
        minZoom: 7,
        zoomControl: false
      });
      currentMarker = new naver.maps.Marker({
        position: userLoc,
        map: map,
        icon: {
          content: '<div style="width:1.7rem;height:1.7rem;background-color:red;border-radius:50%;border:5px solid white;box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
          anchor: new naver.maps.Point(7.5, 7.5)
        }
      });
      fetchAcademies();
      naver.maps.Event.addListener(map, 'idle', fetchAcademies);
      // ì»¤ìŠ¤í…€ ì¤Œ ì»¨íŠ¸ë¡¤ ìƒì„± (ì„¸ë¡œ ë°°ì—´: ìƒë‹¨ "+" / í•˜ë‹¨ "â€“")
      createCustomZoomControl();
    }, err => {
      const defaultLoc = new naver.maps.LatLng(37.5665, 126.9780);
      map = new naver.maps.Map('map', {
        center: defaultLoc,
        zoom: 17,
        minZoom: 7,
        zoomControl: false
      });
      fetchAcademies();
      createCustomZoomControl();
    });
  }

  function createCustomZoomControl() {
    const zoomControlContainer = document.createElement('div');
    // ì›í•˜ëŠ” ìœ„ì¹˜ ì„¤ì •
    zoomControlContainer.style.position = 'absolute';
    zoomControlContainer.style.bottom = '23rem';
    zoomControlContainer.style.right = '1.2rem';
    zoomControlContainer.style.display = 'flex';
    zoomControlContainer.style.flexDirection = 'column'; // ì„¸ë¡œ ë°°ì—´
    zoomControlContainer.style.alignItems = 'center';
    zoomControlContainer.style.borderRadius = '0.4rem';
    zoomControlContainer.style.padding = '0';
    zoomControlContainer.style.margin = '0';
    zoomControlContainer.style.width = '3rem';
    zoomControlContainer.style.height = '4rem';
    zoomControlContainer.style.zIndex = '1';

    // "+" ë²„íŠ¼ (ìœ„ìª½)
    const zoomPlus = document.createElement('button');
    zoomPlus.id = 'zoomPlus';
    zoomPlus.innerText = '+';
    zoomPlus.style.margin = '0 !important';
    zoomPlus.style.padding = '0rem';
    zoomPlus.style.width = '2.7rem';
    zoomPlus.style.height = '2.5rem';
    zoomPlus.style.fontSize = '2rem';
    zoomPlus.style.border = '1px solid lightgray';
    zoomPlus.style.boxShadow = '0 0 0px rgba(0,0,0,0.5)';
    zoomPlus.style.backgroundColor = 'white';
    zoomPlus.style.borderRadius = '0.4rem 0.4rem 0 0';
    zoomControlContainer.appendChild(zoomPlus);

    // "â€“" ë²„íŠ¼ (ì•„ë˜ìª½)
    const zoomMinus = document.createElement('button');
    zoomMinus.id = 'zoomMinus';
    zoomMinus.innerText = 'â€“';
    zoomMinus.style.width = '2.7rem';
    zoomMinus.style.height = '2.2rem';
    zoomMinus.style.margin = '0 !important';
    zoomMinus.style.padding = '0rem';
    zoomMinus.style.fontSize = '2.5rem';
    zoomMinus.style.border = '1px solid lightgray';
    zoomMinus.style.boxShadow = '0 0 0px rgba(0,0,0,0.5)';
    zoomMinus.style.backgroundColor = 'white';
    zoomMinus.style.borderRadius = '0 0 0.4rem 0.4rem';
    zoomControlContainer.appendChild(zoomMinus);

    document.getElementById('map').appendChild(zoomControlContainer);

    // ì¤Œ ë²”ìœ„ ì„¤ì • (ë§µì˜ ìµœì†Œ/ìµœëŒ€ ì¤Œ; ê¸°ë³¸ê°’: 7 ~ 20)
    const minZoom = map.getMinZoom ? map.getMinZoom() : 7;
    const maxZoom = map.getMaxZoom ? map.getMaxZoom() : 20;

    // "+" ë²„íŠ¼ í´ë¦­: ì¤Œ ì¸
    zoomPlus.addEventListener('click', function() {
      let currentZoom = map.getZoom();
      if (currentZoom < maxZoom) {
        map.setZoom(currentZoom + 1);
      }
    });

    // "â€“" ë²„íŠ¼ í´ë¦­: ì¤Œ ì•„ì›ƒ
    zoomMinus.addEventListener('click', function() {
      let currentZoom = map.getZoom();
      if (currentZoom > minZoom) {
        map.setZoom(currentZoom - 1);
      }
    });
  }

  naver.maps.onJSContentLoaded = initMap;
</script>

<script>
  // Block 3: í•™ì› ìë£Œ ë¶ˆëŸ¬ì˜¤ê¸°ì™€ í™”ë©´ í‘œì‹œ ë””ìì¸


  function renderMarkers() {
    clearMarkers();
    const zoomLevel = map.getZoom();
    if (zoomLevel < 16) {
      const grouped = {};
      allAcademyData.forEach(ac => {
        const regionKey = ac.ì‹œêµ°êµ¬ëª… || 'ê¸°íƒ€';
        if (!grouped[regionKey]) grouped[regionKey] = [];
        grouped[regionKey].push(ac);
      });
      for (const region in grouped) {
        const arr = grouped[region];
        if (arr.length === 0) continue;
        const rep = arr[0];
        const markerContent = `
          <div style="min-width:5rem;
                      padding:0.5rem 0.6rem;
                      background-color:#333;
                      color:#fff;
                      border-radius:0.8rem;
                      font-size:1.8rem;
                      font-weight:bold;
                      text-align:center;">
            ${region} (${arr.length})
          </div>
        `;
        placeMarkerNoOverlap(rep.ìœ„ë„, rep.ê²½ë„, markerContent, region);
      }
    } else {
      let groupedByAddress = {};
      allAcademyData.forEach(ac => {
        const address = ac.ë„ë¡œëª…ì£¼ì†Œ || "unknown";
        if (!groupedByAddress[address]) {
          groupedByAddress[address] = [];
        }
        groupedByAddress[address].push(ac);
      });
      for (let address in groupedByAddress) {
        let group = groupedByAddress[address];
        if (group.length === 1) {
          let ac = group[0];
          let markerContent = generateAcademyMarkerContent(ac);
          placeMarkerAt(ac.ìœ„ë„, ac.ê²½ë„, markerContent, ac);
        } else {
          let representative = group[0];
          let bubbleContent = generateBubbleMarkerContent(group);
          placeBubbleMarker(representative.ìœ„ë„, representative.ê²½ë„, bubbleContent, group);
        }
      }
    }
  }

  function placeMarkerAt(lat, lng, content, dataObj) {
    let marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: map,
      icon: { content: content, anchor: new naver.maps.Point(10, 10) },
      title: (typeof dataObj === 'object' && dataObj.ìƒí˜¸ëª…) ? dataObj.ìƒí˜¸ëª… : ''
    });
    naver.maps.Event.addListener(marker, 'click', function(){
      showAcademyInfoPopup(dataObj);
    });
    markers.push(marker);
  }

  function placeBubbleMarker(lat, lng, content, group) {
    let marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(lat, lng),
      map: map,
      icon: { content: content, anchor: new naver.maps.Point(10, 10) },
      title: group.length + "ê°œ í•™ì›"
    });
    naver.maps.Event.addListener(marker, 'click', function(){
      showGroupPopup(group, marker.getPosition());
    });
    markers.push(marker);
  }

  function placeMarkerNoOverlap(lat, lng, content, dataObj) {
    const proj = map.getProjection();
    let screenPt = proj.fromCoordToOffset(new naver.maps.LatLng(lat, lng));
    const markerW = 60, markerH = 24;
    let overlapped = true;
    const MAX_ATTEMPTS = 50;
    let attempts = 0;
    while (overlapped && attempts < MAX_ATTEMPTS) {
      overlapped = false;
      for (let b of markerBoxes) {
        if (Math.abs(screenPt.x - b.x) < markerW && Math.abs(screenPt.y - b.y) < markerH) {
          overlapped = true;
          screenPt.y += markerH + 2;
          break;
        }
      }
      attempts++;
    }
    const finalCoord = proj.fromOffsetToCoord(screenPt);
    const marker = new naver.maps.Marker({
      position: finalCoord,
      map: map,
      icon: { content: content, anchor: new naver.maps.Point(10, 10) },
      title: (typeof dataObj === 'object' && dataObj.ìƒí˜¸ëª…) ? dataObj.ìƒí˜¸ëª… : ''
    });
    naver.maps.Event.addListener(marker, 'click', function() {
      if (typeof dataObj === 'object' && dataObj.id) {
        showAcademyInfoPopup(dataObj);
      } else if (typeof dataObj === 'string') {
        let targetZoom = map.getZoom() + 1;
        map.panTo(marker.getPosition(), { duration: 500 });
        smoothZoom(targetZoom, 500);
      }
    });
    markers.push(marker);
    markerBoxes.push({ x: screenPt.x, y: screenPt.y, w: markerW, h: markerH });
  }

  function generateAcademyMarkerContent(ac) {
    if (selectedCategory === 'ì „ì²´') {
      const academyType = getAcademyType(ac);
      const color = categoryColors[academyType] || 'blue';
      return `
        <div style="display:flex; flex-direction:column; align-items:center;">
          <div style="width:1.4rem; height:1.4rem; background-color:${color}; border:0.25rem solid white; border-radius:50%; margin-bottom:0.25rem;"></div>
          <span style="font-size:1.1rem;
                      color: #333;
                      text-shadow: 0.125rem 0.125rem 0.25rem lightgray;
                      padding:0.25rem 0.5rem;
                      border-radius:0.5rem;">${ac.ìƒí˜¸ëª…}</span>
        </div>
      `;
    } else {
      const color = categoryColors[selectedCategory];
      return `
        <div style="display:flex; flex-direction:column; align-items:center;">
          <div style="width:1.4rem; height:1.4rem; background-color:${color}; border:0.25rem solid white; border-radius:50%; margin-bottom:0.25rem;"></div>
          <span style="font-size:1.1rem;
                      text-shadow: 0.125rem 0.125rem 0.25rem lightgray;
                      color: #333;
                      padding: 0.25rem 0.5rem;
                      border-radius:0.5rem;">${ac.ìƒí˜¸ëª…}</span>
        </div>
      `;
    }
  }

  function generateBubbleMarkerContent(group) {
    let count = group.length;
    let shortAddress = getShortAddress(group[0].ë„ë¡œëª…ì£¼ì†Œ);
    let repType = getAcademyType(group[0]);
    let color = categoryColors[repType] || "#ff5733";
    let content = `
      <div style="position: relative; display: inline-block;">
        <div style="background-color: ${color}D9;
                    color: #fff;
                    border-radius: 0.5rem;
                    padding: 0.6rem;
                    font-size: 1.25rem;
                    text-align: center;
                    box-shadow: 0 0.125rem 0.3125rem rgba(0,0,0,0.5);">
          ${count}ê°œ í•™ì›<br/>
          <div style="font-size: 0.8rem;
                      color: lightgray;">${shortAddress}
          </div>
        </div>
        <div style="position: absolute; left: -10%; transform: rotate(120deg); top: 0%;">
          <div style="width: 0;
                    height: 0;
                    border-left: 6px solid transparent;
                    border-right: 6px solid transparent;
                    border-top: 6px solid ${color};"></div>
        </div>
      </div>
    `;
    return content;
  }

  function showGroupPopup(group, position) {
    const popup = document.getElementById('academyPopup');
    const popupContent = document.getElementById('popupContent');
    let shortAddress = getShortAddress(group[0].ë„ë¡œëª…ì£¼ì†Œ);
    let content = `<div style="font-size: 0.9rem;
                                padding-bottom: 0.5rem;
                                padding-left: 1rem;">${shortAddress}
                      <span style="font-size: 0.8rem;
                                    color: lightgray;
                                    padding-left: 2rem;">|  ì´ ${group.length}ê°œ í•™ì›
                      </span>
                   </div><ul>`;
group.forEach((ac, index) => {
  // ë§ˆì§€ë§‰ í•­ëª©ì´ ì•„ë‹ˆë©´ ì§€ì •í•œ ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
  const borderStyle = (index < group.length - 1)
    ? 'border-bottom: 1px solid #fff; padding-top: 0.3rem; padding-bottom: 0.3rem; width: 80%;'
    : '';
  content += `<li style="${borderStyle}">
      <a style="text-decoration: none;
                font-size: 1.2rem;
                color: black;
                padding: 1rem 1rem 0rem 1rem;
                line-height: 1.4;"
         href="/academy/${ac.id}">
         ${ac.ìƒí˜¸ëª…}
      </a>
    </li>`;
});
    content += `</ul>`;
    popupContent.innerHTML = content;
    popup.classList.add('active');
  }

  function showAcademyInfoPopup(academy) {
    const popup = document.getElementById('academyPopup');
    const popupContent = document.getElementById('popupContent');
    popupContent.innerHTML = `
    <div style="display: flex; align-items: center;">
      <a style="text-decoration: none; color: #333; font-size: 1.5rem;"
         href="/academy/${academy.id}">
        ${academy.ìƒí˜¸ëª…}
      </a>
      <span style="margin-left: 0.5rem; font-size: 1.1rem; color: #777;">
        ${academy.ìƒê¶Œì—…ì¢…ì†Œë¶„ë¥˜ëª… || ''}
      </span>
    </div>
    <div style="padding-left: 1rem;">
      <div style="font-size: 1.3rem;
                    color: #696969;
                    background-color: transparents;">ë³„ì  ${academy.ë³„ì  || 'ì •ë³´ ì—†ìŒ'}</br></div>
        <div>${academy.ë„ë¡œëª…ì£¼ì†Œ || 'ì •ë³´ ì—†ìŒ'}</div>
        <div style="font-size: 1rem;">
          ëŒ€ìƒ:
          ${academy.ëŒ€ìƒ_ìœ ì•„ ? 'ìœ ì•„ ' : ''}
          ${academy.ëŒ€ìƒ_ì´ˆë“± ? 'ì´ˆë“± ' : ''}
          ${academy.ëŒ€ìƒ_ì¤‘ë“± ? 'ì¤‘ë“± ' : ''}
          ${academy.ëŒ€ìƒ_ê³ ë“± ? 'ê³ ë“± ' : ''}
          ${academy.ëŒ€ìƒ_íŠ¹ëª©ê³  ? 'íŠ¹ëª©ê³  ' : ''}
          ${academy.ëŒ€ìƒ_ì¼ë°˜ ? 'ì¼ë°˜ ' : ''}
          ${academy.ëŒ€ìƒ_ê¸°íƒ€ ? 'ê¸°íƒ€' : ''}
        </div>
<table style="border-collapse: collapse; border: none; margin-top: 0.5rem; font-size: 1rem;">
  <tr>
    <td style="padding:0.3rem 0rem; border:none; font-size: 1rem;">
      <strong>ì˜ì—…ì‹œê°„:</strong>
      ${academy.ì˜ì—…ì‹œê°„ && academy.ì˜ì—…ì‹œê°„ !== 'ì—†ìŒ' && academy.ì˜ì—…ì‹œê°„ !== 'false' ? academy.ì˜ì—…ì‹œê°„ : 'ì •ë³´ ì—†ìŒ'}
    </td>
  </tr>
</table>
      </div>
    </div>
    `;
    popup.classList.add('active');
  }

  function closePopup() {
    document.getElementById('academyPopup').classList.remove('active');
  }

  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerBoxes = [];
  }

  function filterMarkers(btn, category) {
    selectedCategory = category;
    const buttons = document.querySelectorAll('#category button');
    buttons.forEach(button => button.classList.remove('active'));
    btn.classList.add('active');
    fetchAcademies();
  }

  function moveToCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLoc = new naver.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        map.setCenter(userLoc);
        map.setZoom(17);
        if (currentMarker) {
          currentMarker.setPosition(userLoc);
        } else {
          currentMarker = new naver.maps.Marker({
            position: userLoc,
            map: map,
            icon: {
              content: '<div style="width:1.7rem;height:1.7rem;background-color:red;border-radius:50%;border:5px solid white;box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
              anchor: new naver.maps.Point(7.5, 7.5)
            }
          });
        }
      }, () => { alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); });
    } else { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
  }

  function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith('csrftoken=')) {
        return cookie.substring('csrftoken='.length);
      }
    }
    return '';
  }
</script>

<script>
  // Block 4: ìˆ˜ê°•ë£Œ! Price Filter Slider Initialization and Panel Toggling
  document.addEventListener('DOMContentLoaded', function() {
    // ì „ì—­ togglePanel í•¨ìˆ˜ ì •ì˜ (HTMLì˜ onclickì—ì„œ í˜¸ì¶œë¨)
    window.togglePanel = function() {
      var panel = document.getElementById("panel-container");
      if (panel.style.display === "none" || panel.style.display === "") {
        panel.style.display = "block";
      } else {
        panel.style.display = "none";
      }
    };

    // ê°€ê²© ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
    // ë²”ìœ„ëŠ” 0 ~ 2,000,000ì› (ì¦‰, 200ë§Œì›)
    var slider = document.getElementById('price-slider');
    var minPrice = 0;
    var maxPrice = 2000000; // 2ë°±ë§Œì›
    // ì´ˆê¸°ê°’: hidden inputì— ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë²”ìœ„ì˜ ëê°’ ì‚¬ìš©
    var initialMin = parseFloat(document.getElementById('price-min').value) || minPrice;
    var initialMax = parseFloat(document.getElementById('price-max').value) || maxPrice;

    noUiSlider.create(slider, {
      start: [initialMin, initialMax],
      connect: true,
      orientation: 'horizontal',  // ê°€ë¡œ ìŠ¬ë¼ì´ë”
      direction: 'ltr',           // ë‚®ì€ ê°’ì€ ì™¼ìª½, ë†’ì€ ê°’ì€ ì˜¤ë¥¸ìª½
      range: {
        'min': minPrice,
        'max': maxPrice
      },
      tooltips: [true, true],
      format: {
        to: function(value) {
          var rounded = Math.round(value);
          if (rounded >= maxPrice) {
            return Math.round(maxPrice).toLocaleString() + " ì´ìƒ";
          }
          return rounded.toLocaleString();
        },
        from: function(value) {
          // ë§Œì•½ valueì— "ì´ìƒ"ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ìµœëŒ€ê°’ì„ ë°˜í™˜
          if (typeof value === 'string' && value.indexOf("ì´ìƒ") !== -1) {
            return maxPrice;
          }
          return Number(value.toString().replace(/,/g, ''));
        }
      }
    });

    // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸ ì‹œ ì¦‰ì‹œ í•„í„° ì ìš© ë° í‘œì‹œê°’(hidden input, íˆ´íŒ) ì—…ë°ì´íŠ¸
    slider.noUiSlider.on('update', function(values, handle) {
      // valuesëŠ” format.to()ê°€ ì ìš©ëœ ë¬¸ìì—´ì´ë¯€ë¡œ, ìˆ«ìë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
      var currentMin = Number(values[0].replace(/[^\d]/g, ''));
      var currentMax = Number(values[1].replace(/[^\d]/g, ''));

document.getElementById('price-slider-min').innerHTML = "ìµœì†Œ <span class='price-value-min'>" + currentMin.toLocaleString() + "</span>ì›";
if (currentMax >= maxPrice) {
  document.getElementById('price-slider-max').innerHTML = "ìµœëŒ€ <span class='price-value-max'>" + Math.round(maxPrice).toLocaleString() + " </span>ì´ìƒ";
  // ìµœëŒ€ê°’ì— ë„ë‹¬í•˜ë©´ hidden inputì— ë§¤ìš° í° ê°’ì„ í• ë‹¹
  document.getElementById('price-max').value = 999999999;
} else {
  document.getElementById('price-slider-max').innerHTML = "ìµœëŒ€ <span class='price-value-max'>" + values[1] + "</span>ì›";
  document.getElementById('price-max').value = currentMax;
}

      document.getElementById('price-min').value = currentMin;

      // ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì¼ ë•Œë§ˆë‹¤ ë°”ë¡œ í•„í„° ì ìš©
      fetchAcademies();
    });
  });
</script>



<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ì „ì—­ ì—°ë ¹ í•„í„° ë°°ì—´: ì„ íƒëœ ì—°ë ¹ ê·¸ë£¹ ê°’ì„ ì €ì¥í•©ë‹ˆë‹¤.
    window.selectedAgeGroups = [];

    // ì—°ë ¹ í•„í„° í† ê¸€ í•¨ìˆ˜: ë²„íŠ¼ì„ í´ë¦­í•  ë•Œ active í´ë˜ìŠ¤ë¥¼ í† ê¸€í•˜ê³  ìŠ¤íƒ€ì¼ì„ ë³€ê²½í•©ë‹ˆë‹¤.
    window.toggleAgeFilter = function(filterName, buttonElement) {
      if (buttonElement.classList.contains('active')) {
        // ë²„íŠ¼ì´ ì´ë¯¸ í™œì„± ìƒíƒœì´ë©´ -> ë¹„í™œì„±í™”: ë°°ê²½ white, ê¸€ì”¨ black
        buttonElement.classList.remove('active');
        buttonElement.style.backgroundColor = "white";
        buttonElement.style.color = "black";
        window.selectedAgeGroups = window.selectedAgeGroups.filter(function(value) {
          return value !== filterName;
        });
      } else {
        // ë²„íŠ¼ì´ ë¹„í™œì„± ìƒíƒœì´ë©´ -> í™œì„±í™”: ë°°ê²½ green, ê¸€ì”¨ white
        buttonElement.classList.add('active');
        buttonElement.style.backgroundColor = "green";
        buttonElement.style.color = "white";
        window.selectedAgeGroups.push(filterName);
      }
      // ì—°ë ¹ í•„í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë°”ë¡œ í•„í„° ì ìš©
      fetchAcademies();
    };
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ì „ì—­ ì…”í‹€ë²„ìŠ¤ í•„í„°: ê¸°ë³¸ì€ false (í•„í„° ë¯¸ì ìš©)
    window.shuttleFilter = false;

    // ì…”í‹€ë²„ìŠ¤ í•„í„° í† ê¸€ í•¨ìˆ˜: ë²„íŠ¼ í´ë¦­ ì‹œ ìƒíƒœ ë° ìŠ¤íƒ€ì¼ í† ê¸€
    window.toggleShuttleFilter = function(buttonElement) {
      if (buttonElement.classList.contains('active')) {
        buttonElement.classList.remove('active');
        buttonElement.style.backgroundColor = "white";
        buttonElement.style.color = "black";
        window.shuttleFilter = false;
      } else {
        buttonElement.classList.add('active');
        buttonElement.style.backgroundColor = "green";
        buttonElement.style.color = "white";
        window.shuttleFilter = true;
      }
      // ì…”í‹€ë²„ìŠ¤ í•„í„° ë³€ê²½ ì‹œ ë°”ë¡œ í•„í„° ì ìš©
      fetchAcademies();
    };
  });
</script>

<!-- fetchAcademies() í•¨ìˆ˜ (Price, Age, Shuttle í•„í„° ëª¨ë‘ ì „ë‹¬) -->
<script>
  function fetchAcademies() {
  if (!map || typeof map.getBounds !== 'function') {
    console.warn("ğŸ›‘ map ê°ì²´ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ getBoundsë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const bounds = map.getBounds();
  const sw = bounds.getSW();
  const ne = bounds.getNE();

  const priceMin = document.getElementById('price-min')?.value || "";
  const priceMax = document.getElementById('price-max')?.value || "";

  fetch('/api/filtered_academies', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify({
      swLat: sw._lat,
      swLng: sw._lng,
      neLat: ne._lat,
      neLng: ne._lng,
      category: selectedCategory,
      priceMin: priceMin,
      priceMax: priceMax,
      ageGroups: window.selectedAgeGroups,
      shuttleFilter: window.shuttleFilter
    })
  })
  .then(res => res.json())
  .then(data => {
    allAcademyData = data;
    renderMarkers();
  })
  .catch(error => console.error('í•™ì› ë°ì´í„° ìš”ì²­ ì—ëŸ¬:', error));
}

</script>

<script>
function filterMarkers(btn, category) {
  selectedCategory = category;
  // #categoryì™€ #panel-category ë‘ ì»¨í…Œì´ë„ˆ ì•ˆì˜ ë²„íŠ¼ë“¤ì„ ëª¨ë‘ ì„ íƒí•©ë‹ˆë‹¤.
  const buttons = document.querySelectorAll('#category button, #panel-category button');
  buttons.forEach(button => {
    button.classList.remove('active');
    // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    button.style.backgroundColor = "";
    button.style.color = "";
  });
  // í´ë¦­í•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
  btn.classList.add('active');

  // ë§Œì•½ í´ë¦­í•œ ë²„íŠ¼ì´ #panel-categoryì— ì†í•˜ì§€ ì•Šìœ¼ë©´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ì ìš©í•©ë‹ˆë‹¤.
  if (btn.parentNode.id !== "panel-category") {
    btn.style.backgroundColor = "green";
    btn.style.color = "white";
  }

  // í•„í„° ì ìš© í•¨ìˆ˜ í˜¸ì¶œ
  fetchAcademies();
}

</script>
<script>
  function waitForNaverMap(callback) {
    if (window.naver && window.naver.maps && typeof window.naver.maps.Map === 'function') {
      console.log("âœ… Naver Maps API ë¡œë“œ ì™„ë£Œ"); // ë””ë²„ê¹…ìš©
      callback();
    } else {
      setTimeout(() => waitForNaverMap(callback), 100);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    waitForNaverMap(initMap);
  });
</script>
{% endblock %}
