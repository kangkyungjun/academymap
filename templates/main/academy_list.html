{% extends "templates/main/base.html" %}
{% block contents %}

{% load static %}
{% load humanize %}

<style>

  .title-bar {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
  }

  /* 오른쪽 - 간단 검색 (search.html) */
  .search-area {
    display: inline-flex;
    align-items: center;
  }

  /* 두 번째 줄: (시도/시군구/행정동/과목 + 검색버튼) => GET: academy_list */
  .filters-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .filters-inner {
    width: 90%;
    max-width: 800px;
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
  }

  .filter-select-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .filter-select-wrap label {
    font-size: 0.8rem;
    font-weight: bold;
    margin-bottom: 0.2rem;
    color: #333;
  }
  .filter-select {
    font-size: 0.8rem;
    padding: 0.3rem;
    border: 1px solid #ccc;
    border-radius: 0.3rem;
    outline: none;
  }

  .filter-btn {
    flex: 0 0 auto; /* 고정 크기 */
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    background-color: #4CAF50;
    color: #fff;
    border: none;
    border-radius: 0.3rem;
    cursor: pointer;
  }
  .filter-btn:hover {
    background-color: #45a049;
  }

  /* 내용 영역: 남은 80vh - 하단 3rem */
  .content-area {
    position: absolute;
    top: 20vh;
    left: 0;
    width: 100%;
    height: calc(100% - 20vh - 3rem);
    overflow-y: auto;
    box-sizing: border-box;
    padding: 1rem;
  }

  /* 학원 목록 아이템 */
  .academy-list-item {
    display: flex;
    border-bottom: 1px solid #ddd;
    padding: 0.5rem 0;
    align-items: flex-start;
  }
  .academy-img-wrap {
    width: 20%;
    min-width: 70px;
    text-align: center;
  }
  .academy-img {
    width: 100%;
    max-width: 120px;
    object-fit: cover;
    border-radius: 0.3rem;
  }
  .academy-info-wrap {
    width: 80%;
    padding-left: 0.5rem;
  }
  .academy-name {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 0.3rem;
    color: #333;
    text-decoration: none;
  }
  .academy-name:hover {
    text-decoration: underline;
  }
  .academy-intro {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 0.3rem;
  }
  .academy-subinfo {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.1rem;
  }

  /* 하단 페이지네이션 (3rem 높이 고정) */
  .pagination {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3rem;
    background-color: #f0f8f8;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
  }
  .pagination a {
    margin: 0 0.5rem;
    font-size: 0.9rem;
    color: #333;
    text-decoration: none;
  }
  .pagination a:hover {
    color: #4CAF50;
    text-decoration: underline;
  }

  @media (max-width: 480px) {
    .academy-img {
      max-width: 80px;
    }
    .academy-name {
      font-size: 0.95rem;
    }
    .academy-intro, .academy-subinfo {
      font-size: 0.75rem;
    }
  }
</style>

<!-- 상단 20vh 영역 -->
<div class="top-bar-container">

  <!-- 첫 줄: 뒤로가기, 아카데미맵, 오른쪽 -> search.html (POST /search) -->
  <div class="top-row">
    <a class="go-back-btn" href="javascript:history.back()">&lt;</a>
    <div class="title-bar"> <a href="{% url 'map' %}">아카데미맵</a></div>
    <div class="search-icon">
    <a href="{% url 'search' %}"><span class="material-symbols-outlined" style="font-size:1.8rem;">search</span></a>
  </div>
  </div>

  <!-- 두 번째 줄: 필터 (시도,시군구,행정동,과목 + '검색'버튼) => GET /academy_list -->
  <form action="{% url 'academy_list' %}" method="get" style="width:100%; margin:0; padding:0;" id="search_form">
    <div class="filters-container">
      <div class="filters-inner">
        <!-- 시도명 -->
        <div class="filter-select-wrap">
          <label for="시도명">시도명</label>
          <select name="시도명" id="시도명" class="filter-select">
            <option value="">-- 선택 --</option>
            {% for region in 시도명_list %}
            <option value="{{ region }}" {% if region == 시도명_selected %}selected{% endif %}>
              {{ region }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- 시군구명 -->
        <div class="filter-select-wrap">
          <label for="시군구명">시군구명</label>
          <select name="시군구명" id="시군구명" class="filter-select"
                  {% if not 시도명_selected %}disabled{% endif %}>
            <option value="">-- 선택 --</option>
            {% if 시군구명_selected %}
            <option value="{{ 시군구명_selected }}" selected>{{ 시군구명_selected }}</option>
            {% endif %}
          </select>
        </div>

        <!-- 행정동명 -->
        <div class="filter-select-wrap">
          <label for="행정동명">행정동명</label>
          <select name="행정동명" id="행정동명" class="filter-select"
                  {% if not 시군구명_selected %}disabled{% endif %}>
            <option value="">-- 선택 --</option>
            {% if 행정동명_selected %}
            <option value="{{ 행정동명_selected }}" selected>{{ 행정동명_selected }}</option>
            {% endif %}
          </select>
        </div>

        <!-- 과목 -->
        <div class="filter-select-wrap">
          <label for="과목">과목</label>
          <select name="과목" id="과목" class="filter-select">
            <option value="">전체</option>
            {% for subject in 과목_list %}
            <option value="{{ subject }}" {% if subject == 과목_selected %}selected{% endif %}>
              {{ subject }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- 검색 버튼 -->
        <button type="submit" class="filter-btn">검색</button>
      </div>
    </div>
  </form>
</div>

<!-- 본문 컨텐츠 (80vh - 3rem 아래 페이지) -->
<div class="content-area">
  {% if academylist %}
    {% for academy in academylist %}
    <div class="academy-list-item">
      <div class="academy-img-wrap">
        {% if academy.학원사진 %}
          <img src="{{ academy.학원사진.url }}" alt="{{ academy.상호명 }}" class="academy-img" />
        {% else %}
          <img src="{% static 'images/no_image.png' %}" alt="No Image" class="academy-img" />
        {% endif %}
      </div>
      <div class="academy-info-wrap">
        <a href="{% url 'academy' academy.id %}" class="academy-name">
          {{ academy.상호명 }}
        </a>
        {% if academy.소개글 %}
        <div class="academy-intro">{{ academy.소개글|linebreaksbr }}</div>
        {% else %}
        <div class="academy-intro">소개 정보가 없습니다.</div>
        {% endif %}

        {% if academy.별점 %}
        <div class="academy-subinfo">별점: ★ {{ academy.별점 }}</div>
        {% endif %}
        <div class="academy-subinfo">지번주소: {{ academy.지번주소 }}</div>
        <div class="academy-subinfo">도로명주소: {{ academy.도로명주소 }}</div>

        <div class="academy-subinfo">
          대상학년:
          {% if academy.대상_유아 %}유아 {% endif %}
          {% if academy.대상_초등 %}초등 {% endif %}
          {% if academy.대상_중등 %}중등 {% endif %}
          {% if academy.대상_고등 %}고등 {% endif %}
          {% if academy.대상_특목고 %}특목고 {% endif %}
          {% if academy.대상_일반 %}일반 {% endif %}
          {% if academy.대상_기타 %}기타{% endif %}
        </div>

        <div class="academy-subinfo">
          과목:
          {% if academy.과목_종합 %}종합 {% endif %}
          {% if academy.과목_수학 %}수학 {% endif %}
          {% if academy.과목_영어 %}영어 {% endif %}
          {% if academy.과목_과학 %}과학 {% endif %}
          {% if academy.과목_외국어 %}외국어 {% endif %}
          {% if academy.과목_예체능 %}예체능 {% endif %}
          {% if academy.과목_컴퓨터 %}컴퓨터 {% endif %}
          {% if academy.과목_논술 %}논술 {% endif %}
          {% if academy.과목_기타 %}기타 {% endif %}
          {% if academy.과목_독서실스터디카페 %}독서실/스터디카페{% endif %}
        </div>
        <div class="academy-subinfo">영업시간: {{ academy.영업시간 }}</div>
        <div class="academy-subinfo">셔틀버스: {{ academy.셔틀버스 }}</div>
        <div class="academy-subinfo">수강료: {{ academy.수강료 }}</div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p>결과가 없습니다.</p>
  {% endif %}
</div>

<!-- 하단 페이지네이션 (이전, n/m, 다음, 마지막) -->
<div class="pagination">
  {% if academylist.has_previous %}
    <a href="?page=1
      {% if 시도명_selected %}&amp;시도명={{ 시도명_selected|urlencode }}{% endif %}
      {% if 시군구명_selected %}&amp;시군구명={{ 시군구명_selected|urlencode }}{% endif %}
      {% if 행정동명_selected %}&amp;행정동명={{ 행정동명_selected|urlencode }}{% endif %}
      {% if 과목_selected %}&amp;과목={{ 과목_selected|urlencode }}{% endif %}
      ">
      처음
    </a>

    <a href="?page={{ academylist.previous_page_number }}
      {% if 시도명_selected %}&amp;시도명={{ 시도명_selected|urlencode }}{% endif %}
      {% if 시군구명_selected %}&amp;시군구명={{ 시군구명_selected|urlencode }}{% endif %}
      {% if 행정동명_selected %}&amp;행정동명={{ 행정동명_selected|urlencode }}{% endif %}
      {% if 과목_selected %}&amp;과목={{ 과목_selected|urlencode }}{% endif %}
      ">
      이전
    </a>
  {% endif %}

  <span>{{ academylist.number }}/{{ academylist.paginator.num_pages }}</span>

  {% if academylist.has_next %}
    <a href="?page={{ academylist.next_page_number }}
      {% if 시도명_selected %}&amp;시도명={{ 시도명_selected|urlencode }}{% endif %}
      {% if 시군구명_selected %}&amp;시군구명={{ 시군구명_selected|urlencode }}{% endif %}
      {% if 행정동명_selected %}&amp;행정동명={{ 행정동명_selected|urlencode }}{% endif %}
      {% if 과목_selected %}&amp;과목={{ 과목_selected|urlencode }}{% endif %}
      ">
      다음
    </a>

    <a href="?page={{ academylist.paginator.num_pages }}
      {% if 시도명_selected %}&amp;시도명={{ 시도명_selected|urlencode }}{% endif %}
      {% if 시군구명_selected %}&amp;시군구명={{ 시군구명_selected|urlencode }}{% endif %}
      {% if 행정동명_selected %}&amp;행정동명={{ 행정동명_selected|urlencode }}{% endif %}
      {% if 과목_selected %}&amp;과목={{ 과목_selected|urlencode }}{% endif %}
      ">
      마지막
    </a>
  {% endif %}
</div>

<!-- AJAX: 시도명 -> 시군구명 -> 행정동명 -->
<script type="text/javascript">
  $(document).ready(function () {
    $("#시도명").change(function () {
      let 시도명 = $(this).val();
      if (시도명) {
        $.ajax({
          url: "{% url 'get_regions' %}",
          data: { level: "시군구명", parent_value: 시도명 },
          success: function (response) {
            let options = '<option value="">-- 선택 --</option>';
            response.regions.forEach(function (region) {
              options += `<option value="${region}">${region}</option>`;
            });
            $("#시군구명").html(options).prop("disabled", false);
            $("#행정동명").html('<option value="">-- 선택 --</option>')
                         .prop("disabled", true);
          }
        });
      } else {
        $("#시군구명").html('<option value="">-- 선택 --</option>').prop("disabled", true);
        $("#행정동명").html('<option value="">-- 선택 --</option>').prop("disabled", true);
      }
    });

    $("#시군구명").change(function () {
      let 시군구명 = $(this).val();
      if (시군구명) {
        $.ajax({
          url: "{% url 'get_regions' %}",
          data: { level: "행정동명", parent_value: 시군구명 },
          success: function (response) {
            let options = '<option value="">-- 선택 --</option>';
            response.regions.forEach(function (region) {
              options += `<option value="${region}">${region}</option>`;
            });
            $("#행정동명").html(options).prop("disabled", false);
          }
        });
      } else {
        $("#행정동명").html('<option value="">-- 선택 --</option>').prop("disabled", true);
      }
    });
  });
</script>

{% endblock %}
