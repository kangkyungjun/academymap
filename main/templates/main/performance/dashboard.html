<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성능 모니터링 대시보드 - AcademyMap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .performance-card {
            transition: transform 0.2s;
        }
        .performance-card:hover {
            transform: translateY(-2px);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .status-healthy { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-tachometer-alt"></i> 성능 모니터링
                </a>
                <div class="navbar-nav">
                    <a class="nav-link" href="/">메인으로</a>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row">
                <div class="col-12">
                    <h1><i class="fas fa-chart-line"></i> 성능 대시보드</h1>
                    <p class="text-muted">실시간 시스템 성능 모니터링 및 관리</p>
                </div>
            </div>

            <!-- 시스템 상태 개요 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card performance-card">
                        <div class="card-body text-center">
                            <i class="fas fa-server fa-2x text-primary mb-2"></i>
                            <h6 class="card-title">시스템 상태</h6>
                            <div id="system-status" class="metric-value status-healthy">양호</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card performance-card">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <h6 class="card-title">평균 응답시간</h6>
                            <div id="avg-response-time" class="metric-value">0.0s</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card performance-card">
                        <div class="card-body text-center">
                            <i class="fas fa-memory fa-2x text-success mb-2"></i>
                            <h6 class="card-title">캐시 적중률</h6>
                            <div id="cache-hit-rate" class="metric-value">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card performance-card">
                        <div class="card-body text-center">
                            <i class="fas fa-database fa-2x text-warning mb-2"></i>
                            <h6 class="card-title">DB 쿼리</h6>
                            <div id="db-queries" class="metric-value">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 상세 메트릭 -->
            <div class="row">
                <!-- 성능 메트릭 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-bar"></i> 성능 메트릭</h5>
                        </div>
                        <div class="card-body">
                            <div id="performance-metrics">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 시스템 메트릭 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-microchip"></i> 시스템 메트릭</h5>
                        </div>
                        <div class="card-body">
                            <div id="system-metrics">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 캐시 관리 -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-hdd"></i> 캐시 관리</h5>
                        </div>
                        <div class="card-body">
                            <div id="cache-status">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-warning" onclick="clearCache('all')">
                                    <i class="fas fa-trash"></i> 전체 캐시 삭제
                                </button>
                                <button class="btn btn-info" onclick="warmupCache()">
                                    <i class="fas fa-fire"></i> 캐시 워밍업
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 데이터베이스 최적화 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-database"></i> DB 최적화</h5>
                        </div>
                        <div class="card-body">
                            <div id="db-optimization">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="createIndexes()">
                                    <i class="fas fa-plus"></i> 인덱스 생성
                                </button>
                                <button class="btn btn-info" onclick="analyzeQueries()">
                                    <i class="fas fa-search"></i> 쿼리 분석
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 프로덕션 준비도 -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-rocket"></i> 프로덕션 준비도</h5>
                        </div>
                        <div class="card-body">
                            <div id="production-readiness">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 성능 데이터 로드
        async function loadPerformanceData() {
            try {
                const response = await fetch('/performance/metrics/');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateMetrics(data.data);
                } else {
                    console.error('성능 데이터 로드 실패:', data.error);
                }
            } catch (error) {
                console.error('API 호출 실패:', error);
            }
        }

        // 메트릭 업데이트
        function updateMetrics(data) {
            // 기본 메트릭
            document.getElementById('avg-response-time').textContent = 
                `${data.performance.request_performance.avg_time.toFixed(3)}s`;
            document.getElementById('cache-hit-rate').textContent = 
                `${(data.cache.hit_rate * 100).toFixed(1)}%`;
            document.getElementById('db-queries').textContent = 
                data.performance.query_performance.total_queries;

            // 성능 메트릭 상세
            const perfMetrics = document.getElementById('performance-metrics');
            perfMetrics.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">총 요청 수</small>
                        <div class="fw-bold">${data.performance.request_performance.total_requests}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">최대 응답시간</small>
                        <div class="fw-bold">${data.performance.request_performance.max_time.toFixed(3)}s</div>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">에러 수</small>
                        <div class="fw-bold text-${data.performance.error_rate.total_errors > 0 ? 'danger' : 'success'}">${data.performance.error_rate.total_errors}</div>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">평균 쿼리/요청</small>
                        <div class="fw-bold">${data.performance.query_performance.avg_queries_per_request.toFixed(1)}</div>
                    </div>
                </div>
            `;

            // 시스템 메트릭
            if (data.system && data.system.system) {
                const sysMetrics = document.getElementById('system-metrics');
                sysMetrics.innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">CPU 사용률</small>
                            <div class="fw-bold">${data.system.system.cpu_percent.toFixed(1)}%</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">메모리 사용률</small>
                            <div class="fw-bold">${data.system.system.memory.percent.toFixed(1)}%</div>
                        </div>
                        <div class="col-6 mt-2">
                            <small class="text-muted">사용 메모리</small>
                            <div class="fw-bold">${(data.system.system.memory.used / 1024 / 1024 / 1024).toFixed(1)}GB</div>
                        </div>
                        <div class="col-6 mt-2">
                            <small class="text-muted">전체 메모리</small>
                            <div class="fw-bold">${(data.system.system.memory.total / 1024 / 1024 / 1024).toFixed(1)}GB</div>
                        </div>
                    </div>
                `;
            }

            // 캐시 상태
            const cacheStatus = document.getElementById('cache-status');
            cacheStatus.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">캐시 상태</small>
                        <div class="fw-bold status-${data.cache.status === 'healthy' ? 'healthy' : 'error'}">${data.cache.status}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">백엔드</small>
                        <div class="fw-bold">${data.cache.backend}</div>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">히트 수</small>
                        <div class="fw-bold">${data.performance.cache_performance.total_hits}</div>
                    </div>
                    <div class="col-6 mt-2">
                        <small class="text-muted">미스 수</small>
                        <div class="fw-bold">${data.performance.cache_performance.total_misses}</div>
                    </div>
                </div>
            `;
        }

        // 캐시 관리 함수들
        async function clearCache(type) {
            const response = await fetch('/performance/cache/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ action: type === 'all' ? 'clear_all' : `clear_${type}` })
            });
            
            const data = await response.json();
            alert(data.message);
            loadPerformanceData();
        }

        async function warmupCache() {
            const response = await fetch('/performance/cache/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ action: 'warm_up' })
            });
            
            const data = await response.json();
            alert(data.message);
            loadPerformanceData();
        }

        // DB 최적화 함수들
        async function createIndexes() {
            const response = await fetch('/performance/database/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ action: 'create_indexes' })
            });
            
            const data = await response.json();
            alert(data.status === 'success' ? '인덱스 생성 완료' : `오류: ${data.error}`);
            loadPerformanceData();
        }

        async function analyzeQueries() {
            const response = await fetch('/performance/database/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ action: 'analyze_queries' })
            });
            
            const data = await response.json();
            console.log('쿼리 분석 결과:', data);
            loadPerformanceData();
        }

        // CSRF 토큰 획득
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 프로덕션 준비도 로드
        async function loadProductionReadiness() {
            try {
                const response = await fetch('/performance/production-readiness/');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const readiness = document.getElementById('production-readiness');
                    readiness.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <h6>준비도 점수</h6>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-${data.data.readiness_score >= 80 ? 'success' : data.data.readiness_score >= 60 ? 'warning' : 'danger'}" 
                                         style="width: ${data.data.readiness_score}%">
                                        ${data.data.readiness_score}점
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h6>보안 체크</h6>
                                ${data.data.security.map(check => `
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-${check.status === 'pass' ? 'check text-success' : check.status === 'warning' ? 'exclamation-triangle text-warning' : 'times text-danger'} me-2"></i>
                                        <span>${check.name}: ${check.message}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('프로덕션 준비도 로드 실패:', error);
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadPerformanceData();
            loadProductionReadiness();
            
            // 5초마다 데이터 업데이트
            setInterval(loadPerformanceData, 5000);
        });
    </script>
</body>
</html>