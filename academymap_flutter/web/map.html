<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„¤ì´ë²„ ì§€ë„</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
  <!-- ë„¤ì´ë²„ ì§€ë„ API -->
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=qcf9quj1gi"></script>
</head>
<body>
  <div id="map"></div>
  
  <script>
    let map = null;
    let markers = [];
    let mapCenter = { lat: 37.5665, lng: 126.978 }; // ê¸°ë³¸ê°’: ì„œìš¸ ì‹œì²­

    // ì§€ë„ ì´ˆê¸°í™”
    function initMap(centerLat = null, centerLng = null) {
      if (typeof naver === 'undefined') {
        console.error('ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      // ì‚¬ìš©ì ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ìœ„ì¹˜ ì‚¬ìš©
      if (centerLat && centerLng) {
        mapCenter = { lat: centerLat, lng: centerLng };
        console.log('ğŸ¯ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì§€ë„ ì´ˆê¸°í™”:', mapCenter);
      } else {
        console.log('ğŸ“ ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸ ì‹œì²­)ë¡œ ì§€ë„ ì´ˆê¸°í™”:', mapCenter);
      }

      const mapOptions = {
        center: new naver.maps.LatLng(mapCenter.lat, mapCenter.lng),
        zoom: centerLat && centerLng ? 13 : 11, // ì‚¬ìš©ì ìœ„ì¹˜ë©´ ë” í™•ëŒ€
        mapTypeControl: false,
        zoomControl: true,
        logoControl: false,
        scaleControl: false,
        mapDataControl: false
      };

      map = new naver.maps.Map('map', mapOptions);
      console.log('ë„¤ì´ë²„ ì§€ë„ iframe ì´ˆê¸°í™” ì™„ë£Œ');
      
      // Flutterì— ì´ˆê¸°í™” ì™„ë£Œ ì•Œë¦¼
      window.parent.postMessage({
        type: 'mapInitialized',
        data: { success: true }
      }, '*');
    }

    // ì§€ë„ ì¤‘ì‹¬ ë³€ê²½
    function setMapCenter(lat, lng) {
      console.log('setMapCenter í˜¸ì¶œ:', lat, lng, typeof lat, typeof lng);
      if (map && lat != null && lng != null && !isNaN(lat) && !isNaN(lng)) {
        const newCenter = new naver.maps.LatLng(parseFloat(lat), parseFloat(lng));
        map.setCenter(newCenter);
        map.setZoom(13); // ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì´ë™ ì‹œ í™•ëŒ€
        mapCenter = { lat: parseFloat(lat), lng: parseFloat(lng) };
        console.log('âœ… ì§€ë„ ì¤‘ì‹¬ ì´ë™ ì™„ë£Œ:', lat, lng);
      } else {
        console.log('âŒ ì§€ë„ ì¤‘ì‹¬ ì´ë™ ì‹¤íŒ¨ - ìœ íš¨í•˜ì§€ ì•Šì€ ì¢Œí‘œ:', lat, lng);
      }
    }

    // ë§ˆì»¤ ì—…ë°ì´íŠ¸
    function updateMarkers(academyData) {
      if (!map) {
        console.error('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      console.log('ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì‹œì‘:', academyData.length + 'ê°œ');

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      markers.forEach(marker => {
        marker.setMap(null);
      });
      markers = [];

      // ìƒˆ ë§ˆì»¤ ì¶”ê°€
      academyData.forEach(academy => {
        if (academy.lat && academy.lng) {
          const position = new naver.maps.LatLng(academy.lat, academy.lng);
          
          const marker = new naver.maps.Marker({
            position: position,
            map: map,
            title: academy.name,
            icon: {
              content: '<div style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); min-width: 20px; text-align: center;">ğŸ«</div>',
              size: new naver.maps.Size(28, 28),
              anchor: new naver.maps.Point(14, 14)
            }
          });

          // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
          const infoWindow = new naver.maps.InfoWindow({
            content: '<div style="padding: 12px; min-width: 200px; max-width: 300px;">' +
                    '<h4 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">' + academy.name + '</h4>' +
                    '<p style="margin: 0 0 4px 0; color: #666; font-size: 12px;">ğŸ“ ' + academy.address + '</p>' +
                    (academy.subject ? '<p style="margin: 4px 0 0 0; color: #007bff; font-size: 11px;">ğŸ“š ' + academy.subject + '</p>' : '') +
                    '</div>',
            maxWidth: 300,
            backgroundColor: '#fff',
            borderColor: '#ddd',
            borderWidth: 1,
            anchorSize: new naver.maps.Size(10, 10)
          });

          naver.maps.Event.addListener(marker, 'click', function() {
            if (infoWindow.getMap()) {
              infoWindow.close();
            } else {
              infoWindow.open(map, marker);
            }
          });

          markers.push(marker);
        }
      });

      console.log(`ì§€ë„ì— ${markers.length}ê°œ ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ`);

      // ë§ˆì»¤ë“¤ì´ ëª¨ë‘ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
      if (markers.length > 0) {
        const bounds = new naver.maps.LatLngBounds();
        markers.forEach(marker => {
          bounds.extend(marker.getPosition());
        });
        map.fitBounds(bounds);
      }
    }

    // Flutterë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', function(event) {
      console.log('iframeì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
      if (event.data.type === 'updateMarkers') {
        updateMarkers(event.data.academies);
      } else if (event.data.type === 'setMapCenter') {
        console.log('setMapCenter ë©”ì‹œì§€ ë°›ìŒ:', event.data);
        setMapCenter(event.data.lat, event.data.lng);
      }
    });

    // í˜ì´ì§€ ë¡œë“œ í›„ ì§€ë„ ì´ˆê¸°í™”
    window.addEventListener('load', function() {
      setTimeout(initMap, 100);
    });
  </script>
</body>
</html>