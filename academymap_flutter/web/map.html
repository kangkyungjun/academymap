<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>네이버 지도</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
  <!-- 네이버 지도 API -->
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=qcf9quj1gi"></script>
</head>
<body>
  <div id="map"></div>
  
  <script>
    let map = null;
    let markers = [];

    // 지도 초기화
    function initMap() {
      if (typeof naver === 'undefined') {
        console.error('네이버 지도 API가 로드되지 않았습니다.');
        return;
      }

      const mapOptions = {
        center: new naver.maps.LatLng(37.5665, 126.978), // 서울 시청
        zoom: 11,
        mapTypeControl: false,
        zoomControl: true,
        logoControl: false,
        scaleControl: false,
        mapDataControl: false
      };

      map = new naver.maps.Map('map', mapOptions);
      console.log('네이버 지도 iframe 초기화 완료');
      
      // Flutter에 초기화 완료 알림
      window.parent.postMessage({
        type: 'mapInitialized',
        data: { success: true }
      }, '*');
    }

    // 마커 업데이트
    function updateMarkers(academyData) {
      if (!map) {
        console.error('지도가 초기화되지 않았습니다.');
        return;
      }

      console.log('마커 업데이트 시작:', academyData.length + '개');

      // 기존 마커 제거
      markers.forEach(marker => {
        marker.setMap(null);
      });
      markers = [];

      // 새 마커 추가
      academyData.forEach(academy => {
        if (academy.lat && academy.lng) {
          const position = new naver.maps.LatLng(academy.lat, academy.lng);
          
          const marker = new naver.maps.Marker({
            position: position,
            map: map,
            title: academy.name,
            icon: {
              content: '<div style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); min-width: 20px; text-align: center;">🏫</div>',
              size: new naver.maps.Size(28, 28),
              anchor: new naver.maps.Point(14, 14)
            }
          });

          // 마커 클릭 이벤트
          const infoWindow = new naver.maps.InfoWindow({
            content: '<div style="padding: 12px; min-width: 200px; max-width: 300px;">' +
                    '<h4 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">' + academy.name + '</h4>' +
                    '<p style="margin: 0 0 4px 0; color: #666; font-size: 12px;">📍 ' + academy.address + '</p>' +
                    (academy.subject ? '<p style="margin: 4px 0 0 0; color: #007bff; font-size: 11px;">📚 ' + academy.subject + '</p>' : '') +
                    '</div>',
            maxWidth: 300,
            backgroundColor: '#fff',
            borderColor: '#ddd',
            borderWidth: 1,
            anchorSize: new naver.maps.Size(10, 10)
          });

          naver.maps.Event.addListener(marker, 'click', function() {
            if (infoWindow.getMap()) {
              infoWindow.close();
            } else {
              infoWindow.open(map, marker);
            }
          });

          markers.push(marker);
        }
      });

      console.log(`지도에 ${markers.length}개 마커 추가 완료`);

      // 마커들이 모두 보이도록 지도 범위 조정
      if (markers.length > 0) {
        const bounds = new naver.maps.LatLngBounds();
        markers.forEach(marker => {
          bounds.extend(marker.getPosition());
        });
        map.fitBounds(bounds);
      }
    }

    // Flutter로부터 메시지 수신
    window.addEventListener('message', function(event) {
      if (event.data.type === 'updateMarkers') {
        updateMarkers(event.data.academies);
      }
    });

    // 페이지 로드 후 지도 초기화
    window.addEventListener('load', function() {
      setTimeout(initMap, 100);
    });
  </script>
</body>
</html>